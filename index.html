<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ImobiManager Pro - Gestão Completa</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Cores Modernas - Tema Profissional */
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --primary-light: #93c5fd;
            --secondary: #64748b;
            --secondary-dark: #475569;
            --accent: #8b5cf6;
            --accent-light: #c4b5fd;
            --success: #10b981;
            --success-light: #a7f3d0;
            --warning: #f59e0b;
            --warning-light: #fde68a;
            --danger: #ef4444;
            --danger-light: #fca5a5;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --surface-dark: #1e293b;
            --border: #e2e8f0;
            --border-dark: #334155;
            
            /* Cores imobiliárias */
            --imovel-new: #06b6d4;
            --imovel-launch: #8b5cf6;
            --imovel-construction: #f59e0b;
            --imovel-ready: #10b981;
            --imovel-lot: #64748b;
            
            /* Dimensões */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(70px + var(--safe-bottom));
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 10px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-float: 0 15px 30px rgba(0, 0, 0, 0.15);
            
            /* Transições */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* Dark Mode Variables */
        .dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #1e3a8a;
            --secondary: #94a3b8;
            --secondary-dark: #64748b;
            --accent: #a78bfa;
            --accent-light: #5b21b6;
            --success: #34d399;
            --success-light: #065f46;
            --warning: #fbbf24;
            --warning-light: #92400e;
            --danger: #f87171;
            --danger-light: #7f1d1d;
            --dark: #f1f5f9;
            --light: #0f172a;
            --surface: #1e293b;
            --surface-dark: #0f172a;
            --border: #334155;
            --border-dark: #475569;
            
            --imovel-new: #22d3ee;
            --imovel-launch: #a78bfa;
            --imovel-construction: #fbbf24;
            --imovel-ready: #34d399;
            --imovel-lot: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }

        .dark-mode body {
            background-color: var(--light);
        }

        /* --- Header Modernizado --- */
        header {
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: var(--safe-top) 20px 15px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .brand {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .brand span {
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            background: var(--light);
            border: 1px solid var(--border);
            font-size: 1.1rem;
            color: var(--secondary);
            padding: 10px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:active {
            background: var(--primary-light);
            color: var(--primary);
            transform: scale(0.95);
            border-color: var(--primary);
        }

        .theme-toggle {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* --- Main Content Area --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 20px) 20px calc(var(--nav-height) + 100px);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Cards & Stats Modernizados --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .stat-card:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background: var(--light);
            transition: all var(--transition-normal);
        }

        .stat-card:active .stat-icon {
            transform: scale(1.1);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--dark);
            line-height: 1;
            letter-spacing: -0.5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-progress {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .stat-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Cores para Stats */
        .bg-blue {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: var(--primary);
        }

        .bg-green {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: var(--success);
        }

        .bg-orange {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            color: var(--warning);
        }

        .bg-red {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: var(--danger);
        }

        .bg-purple {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe);
            color: var(--accent);
        }

        .bg-cyan {
            background: linear-gradient(135deg, #cffafe, #a5f3fc);
            color: var(--imovel-new);
        }

        .bg-teal {
            background: linear-gradient(135deg, #ccfbf1, #99f6e4);
            color: #0d9488;
        }

        /* --- Funil de Metas Integrado --- */
        .metas-section {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .metas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .metas-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metas-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .meta-item {
            background: var(--light);
            border-radius: var(--radius-sm);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid var(--border);
        }

        .meta-label {
            font-size: 0.85rem;
            color: var(--secondary);
            font-weight: 500;
        }

        .meta-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .meta-progress {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .meta-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* --- Funil de Vendas --- */
        .funnel-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 20px 0;
            margin-bottom: 25px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .funnel-container::-webkit-scrollbar {
            display: none;
        }

        .funnel-stage {
            min-width: 280px;
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: all var(--transition-normal);
        }

        .funnel-stage:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .funnel-stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }

        .funnel-stage-title {
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .funnel-stage-count {
            background: var(--light);
            color: var(--dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .funnel-lead-item {
            background: var(--light);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            transition: all var(--transition-fast);
        }

        .funnel-lead-item:active {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* --- List Cards Modernizados --- */
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--dark);
        }

        .section-title .badge {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--surface);
            font-size: 1rem;
            color: var(--dark);
            outline: none;
            transition: all var(--transition-fast);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            font-size: 1.1rem;
        }

        .list-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .list-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, var(--primary), var(--accent));
        }

        .list-card:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--dark);
            line-height: 1.3;
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: var(--secondary);
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 5px;
        }

        .card-price {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
            margin-top: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Tags Modernizadas */
        .tag {
            font-size: 0.7rem;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border: 1px solid transparent;
        }

        .tag-new { background: var(--warning-light); color: #92400e; border-color: #fbbf24; }
        .tag-lead { background: #fef3c7; color: #b45309; border-color: #f59e0b; }
        .tag-prospect { background: #dbeafe; color: #1e40af; border-color: #3b82f6; }
        .tag-negotiation { background: #e9d5ff; color: #6d28d9; border-color: #8b5cf6; }
        .tag-contract { background: #ccfbf1; color: #047857; border-color: #10b981; }
        .tag-closed { background: #dcfce7; color: #15803d; border-color: #22c55e; }
        .tag-lost { background: #fee2e2; color: #b91c1c; border-color: #ef4444; }
        .tag-alert { 
            background: linear-gradient(135deg, #fef3c7, #fde68a); 
            color: #b45309; 
            border-color: #f59e0b;
            animation: pulse 2s infinite;
        }
        .tag-scheduled { background: #fef3c7; color: #b45309; border-color: #f59e0b; }
        .tag-aniversario { 
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            color: #be185d;
            border-color: #ec4899;
        }

        /* Tags para imóveis */
        .tag-pre-lancamento { background: #cffafe; color: #0e7490; border-color: #06b6d4; }
        .tag-lancamento { background: #e0e7ff; color: #4f46e5; border-color: #6366f1; }
        .tag-em-obra { background: #fef3c7; color: #b45309; border-color: #f59e0b; }
        .tag-pronto { background: #d1fae5; color: #047857; border-color: #10b981; }
        .tag-lote { background: #e2e8f0; color: #475569; border-color: #64748b; }

        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .btn-sm {
            flex: 1;
            padding: 10px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-height: 44px;
        }

        .btn-sm:active {
            transform: scale(0.98);
        }

        .btn-light { background: var(--light); color: var(--secondary); border: 1px solid var(--border); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-cyan { background: var(--imovel-new); color: white; }
        .btn-purple { background: var(--accent); color: white; }

        /* --- Bottom Navigation Modernizada --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: 600;
            gap: 4px;
            transition: all var(--transition-fast);
            position: relative;
        }

        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 2px;
            transition: all var(--transition-fast);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active i {
            transform: translateY(-2px);
        }

        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px 3px 0 0;
            transition: width var(--transition-normal);
        }

        .nav-item.active::after {
            width: 30px;
        }

        /* --- Floating Action Button (FAB) --- */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px);
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-float);
            z-index: 900;
            border: none;
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .fab:active {
            transform: scale(0.9) rotate(90deg);
            box-shadow: var(--shadow-lg);
        }

        /* --- Modals / Sheets Modernizados --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1100;
            display: none;
            opacity: 0;
            transition: opacity var(--transition-normal);
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 25px 20px calc(25px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1101;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .modal-overlay.active + .modal-sheet {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        /* --- Forms Modernizados --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--light);
            color: var(--dark);
            transition: all var(--transition-fast);
            -webkit-appearance: none;
        }

        .form-control:focus {
            background: var(--surface);
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: none;
            line-height: 1.5;
        }

        select.form-control {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .btn-block {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            margin-top: 10px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-block:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* --- Card de Detalhes Modernizado --- */
        .details-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .details-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--dark);
            line-height: 1.2;
        }

        .details-subtitle {
            font-size: 0.95rem;
            color: var(--secondary);
            margin-top: 5px;
        }

        .details-section {
            margin-bottom: 25px;
        }

        .details-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .details-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .info-label {
            font-size: 0.85rem;
            color: var(--secondary);
            font-weight: 500;
        }

        .info-value {
            font-size: 1.05rem;
            color: var(--dark);
            font-weight: 600;
            line-height: 1.3;
        }

        .private-notes {
            background: var(--warning-light);
            border-left: 4px solid var(--warning);
            padding: 16px 20px;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-top: 20px;
        }

        .private-notes-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .private-notes-content {
            font-size: 0.95rem;
            color: #7c2d12;
            line-height: 1.4;
        }

        .details-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid var(--border);
        }

        .btn-details {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-height: 50px;
        }

        .btn-details:active {
            transform: scale(0.98);
        }

        .btn-details-primary {
            background: var(--primary);
            color: white;
        }

        .btn-details-success {
            background: var(--success);
            color: white;
        }

        .btn-details-warning {
            background: var(--warning);
            color: white;
        }

        .btn-details-danger {
            background: var(--danger);
            color: white;
        }

        .btn-details-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-details-secondary {
            background: var(--light);
            color: var(--secondary);
            border: 1px solid var(--border);
        }

        /* --- Preview de Fotos Modernizado --- */
        .photos-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .photo-preview {
            width: 70px;
            height: 70px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            border: 2px solid var(--border);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .photo-preview:active {
            transform: scale(0.95);
            border-color: var(--primary);
        }

        .photo-upload-area {
            width: 70px;
            height: 70px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .photo-upload-area:active {
            background: var(--light);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* --- Modal de Fotos em Tela Cheia --- */
        .photo-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .photo-fullscreen img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: var(--radius-sm);
        }

        .photo-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .photo-nav:active {
            background: rgba(255, 255, 255, 0.2);
        }

        .photo-nav.prev {
            left: 20px;
        }

        .photo-nav.next {
            right: 20px;
        }

        .photo-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .photo-close:active {
            background: rgba(255, 255, 255, 0.2);
        }

        .photo-counter {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* --- Configuração de Metas --- */
        .metas-config {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .meta-config-item {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .meta-config-label {
            font-size: 0.95rem;
            color: var(--dark);
            font-weight: 500;
        }

        .meta-config-input {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--light);
            color: var(--dark);
            text-align: center;
            transition: all var(--transition-fast);
        }

        .meta-config-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* --- Relatórios Modernizados --- */
        .report-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all var(--transition-normal);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .report-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, var(--primary), var(--accent));
        }

        .report-card:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .report-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- Animações --- */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* --- Utilitários --- */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--secondary);
        }

        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 1rem;
            font-weight: 500;
        }

        .toast {
            position: fixed;
            top: calc(var(--header-height) + 10px);
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark);
            color: white;
            padding: 15px 25px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .hidden {
            display: none !important;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        .badge-cyan {
            background: var(--imovel-new);
            color: white;
        }

        /* --- Responsividade --- */
        @media (max-width: 480px) {
            .stats-grid,
            .metas-grid {
                grid-template-columns: 1fr;
            }
            
            .details-info-grid {
                grid-template-columns: 1fr;
            }
            
            .details-actions {
                flex-direction: column;
            }
            
            .action-row {
                flex-direction: column;
            }
            
            .funnel-stage {
                min-width: 260px;
            }
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .metas-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* --- Scrollbar Personalizada --- */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .dark-mode ::-webkit-scrollbar-track {
            background: var(--surface-dark);
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: var(--border-dark);
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fas fa-home" style="background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
            Imobi<span>Manager</span> <span style="font-size: 0.7rem; background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; margin-left: 5px;">PRO</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="App.backup.exportData()" title="Exportar Backup">
                <i class="fas fa-cloud-download-alt"></i>
            </button>
            <button class="icon-btn" onclick="UI.openMetasConfig()" title="Configurar Metas">
                <i class="fas fa-bullseye"></i>
            </button>
            <button class="icon-btn" onclick="UI.openSettings()" title="Configurações">
                <i class="fas fa-cog"></i>
            </button>
            <button class="theme-toggle" onclick="UI.toggleTheme()" title="Alternar Tema">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i> <span>Ação realizada!</span>
    </div>

    <main>
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view active">
            <div class="section-title">Visão Geral do Mês</div>
            
            <!-- Cards de Estatísticas -->
            <div class="stats-grid">
                <div class="stat-card" onclick="UI.navigate('clientes')">
                    <div class="stat-icon bg-blue"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="dash-total-clientes">0</div>
                    <div class="stat-label">Total Clientes</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card" onclick="UI.navigate('imoveis')">
                    <div class="stat-icon bg-purple"><i class="fas fa-building"></i></div>
                    <div class="stat-value" id="dash-total-imoveis">0</div>
                    <div class="stat-label">Imóveis</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card" onclick="UI.navigateToAgenda('today')">
                    <div class="stat-icon bg-orange"><i class="fas fa-calendar-day"></i></div>
                    <div class="stat-value" id="dash-agenda-hoje">0</div>
                    <div class="stat-label">Agenda Hoje</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card" onclick="UI.navigate('metas')">
                    <div class="stat-icon bg-teal"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-value" id="dash-metas-progresso">0%</div>
                    <div class="stat-label">Meta Mensal</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="dash-metas-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card" onclick="UI.navigate('funil')">
                    <div class="stat-icon bg-cyan"><i class="fas fa-filter"></i></div>
                    <div class="stat-value" id="dash-leads-ativos">0</div>
                    <div class="stat-label">Leads Ativos</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card" onclick="UI.navigate('relatorios')">
                    <div class="stat-icon bg-green"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="dash-receita-mes">R$ 0</div>
                    <div class="stat-label">Receita/Mês</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Seção de Metas -->
            <div class="section-title">
                Desempenho de Metas
                <span class="badge" id="metas-badge">Mês</span>
            </div>
            <div class="metas-section">
                <div class="metas-grid">
                    <div class="meta-item">
                        <div class="meta-label">Vendas</div>
                        <div class="meta-value"><span id="meta-vendas-atual">0</span>/<span id="meta-vendas-total">0</span></div>
                        <div class="meta-progress">
                            <div class="meta-progress-bar" id="meta-vendas-bar" style="width: 0%; background: var(--success);"></div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Receita</div>
                        <div class="meta-value"><span id="meta-receita-atual">R$ 0</span>/<span id="meta-receita-total">R$ 0</span></div>
                        <div class="meta-progress">
                            <div class="meta-progress-bar" id="meta-receita-bar" style="width: 0%; background: var(--primary);"></div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Novos Clientes</div>
                        <div class="meta-value"><span id="meta-clientes-atual">0</span>/<span id="meta-clientes-total">0</span></div>
                        <div class="meta-progress">
                            <div class="meta-progress-bar" id="meta-clientes-bar" style="width: 0%; background: var(--accent);"></div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Visitas</div>
                        <div class="meta-value"><span id="meta-visitas-atual">0</span>/<span id="meta-visitas-total">0</span></div>
                        <div class="meta-progress">
                            <div class="meta-progress-bar" id="meta-visitas-bar" style="width: 0%; background: var(--warning);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aniversariantes do Dia -->
            <div class="section-title">
                Aniversariantes Hoje
                <span class="badge badge-cyan" id="aniversario-badge" style="display:none">!</span>
            </div>
            <div id="aniversariantes-list">
                <div class="empty-state">
                    <i class="fas fa-birthday-cake"></i>
                    <p>Nenhum aniversariante hoje!</p>
                </div>
            </div>

            <!-- Agenda para Hoje -->
            <div class="section-title">
                Agenda para Hoje
                <span class="badge badge-warning" id="agenda-badge" style="display:none">!</span>
            </div>
            <div id="agenda-hoje-list">
                <div class="empty-state">
                    <i class="fas fa-calendar-check"></i>
                    <p>Nenhum agendamento para hoje!</p>
                </div>
            </div>

            <!-- Follow-ups -->
            <div class="section-title">
                Follow-ups Pendentes
                <span class="badge badge-danger" id="followup-badge" style="display:none">!</span>
            </div>
            <div id="followup-list">
                <div class="empty-state">
                    <i class="fas fa-thumbs-up"></i>
                    <p>Nenhum follow-up necessário!</p>
                </div>
            </div>
        </div>

        <!-- Clientes View -->
        <div id="clientes-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar clientes..." oninput="UI.renderClientes(this.value)">
            </div>
            
            <div class="filter-buttons" style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px;">
                <button class="filter-btn active" onclick="UI.filterClientes('all')">Todos</button>
                <button class="filter-btn" onclick="UI.filterClientes('lead')">Leads</button>
                <button class="filter-btn" onclick="UI.filterClientes('prospect')">Prospects</button>
                <button class="filter-btn" onclick="UI.filterClientes('negotiation')">Negociação</button>
                <button class="filter-btn" onclick="UI.filterClientes('contract')">Contrato</button>
                <button class="filter-btn" onclick="UI.filterClientes('closed')">Fechados</button>
                <button class="filter-btn" onclick="UI.filterClientes('lost')">Perdidos</button>
            </div>
            
            <div id="clientes-list"></div>
        </div>

        <!-- Imóveis View -->
        <div id="imoveis-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar imóveis..." oninput="UI.renderImoveis(this.value)">
            </div>
            
            <div class="filter-buttons" style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px;">
                <button class="filter-btn active" onclick="UI.filterImoveis('all')">Todos</button>
                <button class="filter-btn" onclick="UI.filterImoveis('pre-lancamento')">Pré-lançamento</button>
                <button class="filter-btn" onclick="UI.filterImoveis('lancamento')">Lançamento</button>
                <button class="filter-btn" onclick="UI.filterImoveis('em-obra')">Em Obra</button>
                <button class="filter-btn" onclick="UI.filterImoveis('pronto')">Pronto</button>
                <button class="filter-btn" onclick="UI.filterImoveis('lote')">Lotes</button>
                <button class="filter-btn" onclick="UI.filterImoveis('vendido')">Vendidos</button>
                <button class="filter-btn" onclick="UI.filterImoveis('disponivel')">Disponíveis</button>
            </div>
            
            <div id="imoveis-list"></div>
        </div>

        <!-- Funil View -->
        <div id="funil-view" class="view">
            <div class="section-title">Funil de Vendas Personalizado</div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-sm btn-primary" onclick="UI.openNovaEtapaFunil()">
                    <i class="fas fa-plus"></i> Nova Etapa
                </button>
                <button class="btn-sm btn-light" onclick="UI.editarEtapasFunil()">
                    <i class="fas fa-edit"></i> Editar Etapas
                </button>
            </div>
            
            <div class="funnel-container" id="funnel-stages-container">
                <!-- Etapas do funil serão carregadas dinamicamente -->
            </div>
            
            <div class="section-title">Estatísticas do Funil</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-signal"></i></div>
                    <div class="stat-value" id="funil-taxa-conversao">0%</div>
                    <div class="stat-label">Taxa Conversão</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-clock"></i></div>
                    <div class="stat-value" id="funil-tempo-medio">0 dias</div>
                    <div class="stat-label">Tempo Médio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-value" id="funil-valor-medio">R$ 0</div>
                    <div class="stat-label">Ticket Médio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-red"><i class="fas fa-times-circle"></i></div>
                    <div class="stat-value" id="funil-perdidos">0</div>
                    <div class="stat-label">Perdidos</div>
                </div>
            </div>
        </div>

        <!-- Agenda View -->
        <div id="agenda-view" class="view">
            <div class="section-title">Agenda Completa</div>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar na agenda..." oninput="UI.renderAgenda(this.value)">
            </div>
            
            <div class="filter-buttons" style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px;">
                <button class="filter-btn active" onclick="UI.filterAgenda('today')">Hoje</button>
                <button class="filter-btn" onclick="UI.filterAgenda('week')">Esta Semana</button>
                <button class="filter-btn" onclick="UI.filterAgenda('month')">Este Mês</button>
                <button class="filter-btn" onclick="UI.filterAgenda('visita')">Visitas</button>
                <button class="filter-btn" onclick="UI.filterAgenda('reuniao')">Reuniões</button>
                <button class="filter-btn" onclick="UI.filterAgenda('assinatura')">Assinaturas</button>
                <button class="filter-btn" onclick="UI.filterAgenda('plantao')">Plantões</button>
            </div>
            
            <div id="agenda-list"></div>
        </div>

        <!-- Metas View -->
        <div id="metas-view" class="view">
            <div class="section-title">Metas e Desempenho</div>
            
            <div class="metas-config">
                <div class="section-title" style="margin-bottom: 20px;">
                    <i class="fas fa-bullseye"></i> Configurar Metas Mensais
                </div>
                
                <div class="meta-config-item">
                    <div class="meta-config-label">Meta de Leads/Mês</div>
                    <input type="number" class="meta-config-input" id="config-meta-leads" value="100" min="1">
                </div>
                
                <div class="meta-config-item">
                    <div class="meta-config-label">Conversão Leads → Visitas</div>
                    <input type="number" class="meta-config-input" id="config-conv-leads-visitas" value="40" min="0" max="100">
                    <div style="grid-column: 1 / -1; font-size: 0.8rem; color: var(--secondary); margin-top: -10px;">%</div>
                </div>
                
                <div class="meta-config-item">
                    <div class="meta-config-label">Conversão Visitas → Docs</div>
                    <input type="number" class="meta-config-input" id="config-conv-visitas-docs" value="50" min="0" max="100">
                    <div style="grid-column: 1 / -1; font-size: 0.8rem; color: var(--secondary); margin-top: -10px;">%</div>
                </div>
                
                <div class="meta-config-item">
                    <div class="meta-config-label">Conversão Docs → Aprovações</div>
                    <input type="number" class="meta-config-input" id="config-conv-docs-aprovacoes" value="80" min="0" max="100">
                    <div style="grid-column: 1 / -1; font-size: 0.8rem; color: var(--secondary); margin-top: -10px;">%</div>
                </div>
                
                <div class="meta-config-item">
                    <div class="meta-config-label">Conversão Aprovações → Vendas</div>
                    <input type="number" class="meta-config-input" id="config-conv-aprovacoes-vendas" value="75" min="0" max="100">
                    <div style="grid-column: 1 / -1; font-size: 0.8rem; color: var(--secondary); margin-top: -10px;">%</div>
                </div>
                
                <button class="btn-block" onclick="App.metas.salvarConfig()">
                    <i class="fas fa-save"></i> Salvar Configuração de Metas
                </button>
            </div>
            
            <div class="section-title">Análise de Performance</div>
            <div class="metas-section">
                <div id="performance-analysis">
                    <!-- Análise será carregada aqui -->
                </div>
            </div>
            
            <div class="section-title">Progresso Detalhado</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-value" id="meta-progresso-leads">0%</div>
                    <div class="stat-label">Leads</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="meta-bar-leads" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-value" id="meta-progresso-visitas">0%</div>
                    <div class="stat-label">Visitas</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="meta-bar-visitas" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-value" id="meta-progresso-docs">0%</div>
                    <div class="stat-label">Documentos</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="meta-bar-docs" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-value" id="meta-progresso-aprovacoes">0%</div>
                    <div class="stat-label">Aprovações</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="meta-bar-aprovacoes" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relatórios View -->
        <div id="relatorios-view" class="view">
            <div class="section-title">Relatórios Profissionais</div>
            
            <div class="report-card" onclick="App.relatorios.gerarVendas()">
                <div class="report-title"><i class="fas fa-handshake"></i> Relatório de Vendas</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            
            <div class="report-card" onclick="App.relatorios.gerarPlantao()">
                <div class="report-title"><i class="fas fa-calendar-alt"></i> Relatório de Plantão</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            
            <div class="report-card" onclick="App.relatorios.gerarClientes()">
                <div class="report-title"><i class="fas fa-users"></i> Relatório de Clientes</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            
            <div class="report-card" onclick="App.relatorios.gerarImoveis()">
                <div class="report-title"><i class="fas fa-building"></i> Relatório de Imóveis</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            
            <div class="report-card" onclick="App.relatorios.gerarAniversariantes()">
                <div class="report-title"><i class="fas fa-birthday-cake"></i> Relatório de Aniversariantes</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            
            <div class="report-card" onclick="App.relatorios.gerarDesempenhoFunil()">
                <div class="report-title"><i class="fas fa-filter"></i> Desempenho do Funil</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            
            <div class="report-card" onclick="App.relatorios.gerarMetas()">
                <div class="report-title"><i class="fas fa-bullseye"></i> Relatório de Metas</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            
            <div class="report-card" onclick="App.relatorios.gerarFinanceiro()">
                <div class="report-title"><i class="fas fa-chart-line"></i> Relatório Financeiro</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
        </div>
    </main>

    <!-- FAB Principal -->
    <button class="fab" onclick="UI.openNewCliente()" id="main-fab">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this)">
            <i class="fas fa-home"></i> <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this)">
            <i class="fas fa-user-friends"></i> <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-target="imoveis-view" onclick="UI.switchTab(this)">
            <i class="fas fa-building"></i> <span>Imóveis</span>
        </a>
        <a href="#" class="nav-item" data-target="funil-view" onclick="UI.switchTab(this)">
            <i class="fas fa-filter"></i> <span>Funil</span>
        </a>
        <a href="#" class="nav-item" data-target="agenda-view" onclick="UI.switchTab(this)">
            <i class="fas fa-calendar-alt"></i> <span>Agenda</span>
        </a>
        <a href="#" class="nav-item" data-target="metas-view" onclick="UI.switchTab(this)">
            <i class="fas fa-bullseye"></i> <span>Metas</span>
        </a>
        <a href="#" class="nav-item" data-target="relatorios-view" onclick="UI.switchTab(this)">
            <i class="fas fa-chart-bar"></i> <span>Relatórios</span>
        </a>
    </nav>

    <!-- Modal de Detalhes do Cliente -->
    <div class="modal-overlay" id="overlay-cliente-details"></div>
    <div class="modal-sheet" id="sheet-cliente-details">
        <div class="sheet-handle"></div>
        <div id="cliente-details-content"></div>
    </div>

    <!-- Modal de Detalhes do Imóvel -->
    <div class="modal-overlay" id="overlay-imovel-details"></div>
    <div class="modal-sheet" id="sheet-imovel-details">
        <div class="sheet-handle"></div>
        <div id="imovel-details-content"></div>
    </div>

    <!-- Modal de Fotos em Tela Cheia -->
    <div class="photo-fullscreen hidden" id="photo-fullscreen">
        <button class="photo-close" onclick="UI.closePhotoFullscreen()">
            <i class="fas fa-times"></i>
        </button>
        <button class="photo-nav prev" onclick="UI.prevPhoto()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <img id="fullscreen-photo" src="" alt="">
        <button class="photo-nav next" onclick="UI.nextPhoto()">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="photo-counter" id="photo-counter">1 / 1</div>
    </div>

    <!-- Modal de Cadastro/Edição de Cliente -->
    <div class="modal-overlay" id="overlay-cliente"></div>
    <div class="modal-sheet" id="sheet-cliente">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-cliente">Novo Cliente</h3>
        <form id="form-cliente" onsubmit="App.cliente.save(event)">
            <input type="hidden" id="c-id">
            <div class="form-group">
                <label class="form-label">Nome Completo *</label>
                <input type="text" id="c-nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Telefone (WhatsApp) *</label>
                <input type="tel" id="c-telefone" class="form-control" placeholder="(00) 00000-0000" required oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="c-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Data de Nascimento</label>
                <input type="date" id="c-nascimento" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">CPF</label>
                <input type="text" id="c-cpf" class="form-control" placeholder="000.000.000-00" oninput="Utils.maskCPF(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Renda Mensal (R$)</label>
                <input type="text" id="c-renda" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Status no Funil</label>
                <select id="c-status" class="form-control">
                    <option value="lead">Lead</option>
                    <option value="prospect">Prospect</option>
                    <option value="negotiation">Negociação</option>
                    <option value="contract">Contrato</option>
                    <option value="closed">Fechado</option>
                    <option value="lost">Perdido</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Imóveis de Interesse</label>
                <div id="c-imoveis-interesse-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: var(--light);">
                    <!-- Imóveis serão carregados dinamicamente -->
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Observações</label>
                <textarea id="c-observacoes" class="form-control" placeholder="Anotações sobre o cliente..." rows="3"></textarea>
            </div>
            <button type="submit" class="btn-block">Salvar Cliente</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Cadastro/Edição de Imóvel -->
    <div class="modal-overlay" id="overlay-imovel"></div>
    <div class="modal-sheet" id="sheet-imovel">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-imovel">Novo Imóvel</h3>
        <form id="form-imovel" onsubmit="App.imovel.save(event)">
            <input type="hidden" id="i-id">
            
            <div class="form-group">
                <label class="form-label">Tipo de Imóvel *</label>
                <select id="i-tipo" class="form-control" required onchange="App.imovel.toggleTipoFields()">
                    <option value="apartamento">Apartamento</option>
                    <option value="casa">Casa</option>
                    <option value="comercial">Comercial</option>
                    <option value="terreno">Terreno</option>
                    <option value="lote">Lote</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Nome/Descrição *</label>
                <input type="text" id="i-nome" class="form-control" placeholder="Ex: Apartamento 2 quartos com varanda gourmet" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Modalidade *</label>
                <select id="i-modalidade" class="form-control" required>
                    <option value="pre-lancamento">Pré-lançamento</option>
                    <option value="lancamento">Lançamento</option>
                    <option value="em-obra">Em Obra</option>
                    <option value="pronto">Pronto</option>
                    <option value="lote">Lote</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Construtora/Incorporadora</label>
                <input type="text" id="i-construtora" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label">Valor (R$) *</label>
                <input type="text" id="i-valor" class="form-control" placeholder="0,00" required oninput="Utils.maskMoney(this)">
            </div>
            
            <div class="form-group">
                <label class="form-label">Forma de Pagamento</label>
                <textarea id="i-forma-pagamento" class="form-control" placeholder="Descrição da forma de pagamento..." rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Data de Entrega</label>
                <input type="date" id="i-data-entrega" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label">Localização</label>
                <textarea id="i-localizacao" class="form-control" placeholder="Endereço completo ou descrição da localização..." rows="2"></textarea>
            </div>
            
            <!-- Campos dinâmicos -->
            <div id="campos-apartamento" class="dynamic-fields active">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                    <div>
                        <label class="form-label">Quartos</label>
                        <input type="number" id="i-quartos" class="form-control" min="0">
                    </div>
                    <div>
                        <label class="form-label">Banheiros</label>
                        <input type="number" id="i-banheiros" class="form-control" min="0">
                    </div>
                    <div>
                        <label class="form-label">Vagas</label>
                        <input type="number" id="i-vagas" class="form-control" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Área Total (m²)</label>
                    <input type="text" id="i-area" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                </div>
            </div>
            
            <div id="campos-lote" class="dynamic-fields hidden">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                    <div>
                        <label class="form-label">Largura (m)</label>
                        <input type="text" id="i-largura" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                    </div>
                    <div>
                        <label class="form-label">Comprimento (m)</label>
                        <input type="text" id="i-comprimento" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                    </div>
                    <div>
                        <label class="form-label">Área Total (m²)</label>
                        <input type="text" id="i-area-lote" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Descrição Completa</label>
                <textarea id="i-descricao" class="form-control" placeholder="Descreva detalhadamente o imóvel..." rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Fotos (até 20)</label>
                <div class="photos-preview-container" id="fotos-container">
                    <!-- Fotos serão adicionadas aqui -->
                </div>
                <div style="text-align: center;">
                    <label for="i-fotos-input" class="btn-sm btn-light" style="display: inline-flex; margin-top: 8px;">
                        <i class="fas fa-plus"></i> Adicionar Fotos
                    </label>
                    <input type="file" id="i-fotos-input" accept="image/*" style="display: none;" multiple onchange="App.imovel.handleFotos(this)">
                    <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                        Clique para adicionar fotos (máximo 20)
                    </div>
                </div>
                <input type="hidden" id="i-fotos-data">
            </div>
            
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="i-status" class="form-control">
                    <option value="disponivel">Disponível</option>
                    <option value="reservado">Reservado</option>
                    <option value="vendido">Vendido</option>
                </select>
            </div>

            <button type="submit" class="btn-block">Salvar Imóvel</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal para Agendamento de Visita -->
    <div class="modal-overlay" id="overlay-agenda-visita"></div>
    <div class="modal-sheet" id="sheet-agenda-visita">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Agendar Visita</h3>
        <form id="form-agenda-visita" onsubmit="App.agenda.saveVisita(event)">
            <input type="hidden" id="av-id">
            
            <div class="form-group">
                <label class="form-label">Cliente *</label>
                <select id="av-cliente" class="form-control" required>
                    <!-- Clientes serão carregados dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Imóvel *</label>
                <select id="av-imovel" class="form-control" required>
                    <option value="">Selecione um imóvel...</option>
                    <!-- Imóveis serão carregados dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Data *</label>
                <input type="date" id="av-data" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Horário *</label>
                <input type="time" id="av-horario" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Local (se diferente do imóvel)</label>
                <input type="text" id="av-local" class="form-control" placeholder="Endereço alternativo...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Tipo de Visita</label>
                <select id="av-tipo-visita" class="form-control">
                    <option value="primeira">Primeira Visita</option>
                    <option value="retorno">Retorno</option>
                    <option value="tecnica">Visita Técnica</option>
                    <option value="final">Visita Final</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Observações</label>
                <textarea id="av-observacoes" class="form-control" placeholder="Detalhes importantes para a visita..." rows="3"></textarea>
            </div>

            <button type="submit" class="btn-block">Agendar Visita</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal para Agendamento de Reunião -->
    <div class="modal-overlay" id="overlay-agenda-reuniao"></div>
    <div class="modal-sheet" id="sheet-agenda-reuniao">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Agendar Reunião</h3>
        <form id="form-agenda-reuniao" onsubmit="App.agenda.saveReuniao(event)">
            <input type="hidden" id="ar-id">
            
            <div class="form-group">
                <label class="form-label">Cliente *</label>
                <select id="ar-cliente" class="form-control" required>
                    <!-- Clientes serão carregados dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Assunto *</label>
                <input type="text" id="ar-assunto" class="form-control" placeholder="Ex: Negociação de contrato" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Data *</label>
                <input type="date" id="ar-data" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Horário *</label>
                <input type="time" id="ar-horario" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Local *</label>
                <input type="text" id="ar-local" class="form-control" placeholder="Endereço ou link da reunião..." required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Tipo de Reunião</label>
                <select id="ar-tipo" class="form-control">
                    <option value="negociacao">Negociação</option>
                    <option value="contrato">Assinatura de Contrato</option>
                    <option value="apresentacao">Apresentação</option>
                    <option value="followup">Follow-up</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Participantes</label>
                <input type="text" id="ar-participantes" class="form-control" placeholder="Nomes dos participantes...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Pauta/Objetivos</label>
                <textarea id="ar-pauta" class="form-control" placeholder="Itens a serem discutidos..." rows="3"></textarea>
            </div>

            <button type="submit" class="btn-block">Agendar Reunião</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal para Nova Etapa do Funil -->
    <div class="modal-overlay" id="overlay-etapa-funil"></div>
    <div class="modal-sheet" id="sheet-etapa-funil">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-etapa-funil">Nova Etapa do Funil</h3>
        <form id="form-etapa-funil" onsubmit="App.funil.saveEtapa(event)">
            <input type="hidden" id="etapa-id">
            <div class="form-group">
                <label class="form-label">Nome da Etapa *</label>
                <input type="text" id="etapa-nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Cor da Etapa</label>
                <input type="color" id="etapa-cor" class="form-control" value="#3b82f6" style="height: 50px; width: 100%; padding: 5px;">
            </div>
            <div class="form-group">
                <label class="form-label">Ordem (menor aparece primeiro) *</label>
                <input type="number" id="etapa-ordem" class="form-control" required min="1" value="1">
            </div>
            <div class="form-group">
                <label class="form-label">Descrição</label>
                <textarea id="etapa-descricao" class="form-control" placeholder="Descrição da etapa..." rows="2"></textarea>
            </div>
            <button type="submit" class="btn-block">Salvar Etapa</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Configurações -->
    <div class="modal-overlay" id="overlay-settings"></div>
    <div class="modal-sheet" id="sheet-settings">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Configurações</h3>
        <form id="form-settings" onsubmit="App.settings.save(event)">
            <div class="logo-preview-container" style="width: 100%; display: flex; justify-content: center; margin-bottom: 20px;">
                <img id="s-logo-preview" class="logo-preview" src="" style="display:none; width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border);">
                <div id="s-logo-placeholder" class="logo-preview" style="display:flex; align-items:center; justify-content:center; color:var(--secondary); width: 120px; height: 120px; border-radius: 50%; background: var(--light); border: 2px dashed var(--border);">
                    <i class="fas fa-image" style="font-size: 2rem;"></i>
                </div>
            </div>
            <div class="form-group" style="text-align: center;">
                <label for="s-logo-input" style="color: var(--primary); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-upload"></i> Carregar Logomarca
                </label>
                <input type="file" id="s-logo-input" accept="image/*" style="display: none;" onchange="App.settings.previewLogo(this)">
                <input type="hidden" id="s-logo-data">
            </div>

            <div class="form-group">
                <label class="form-label">Nome do Corretor/Imobiliária *</label>
                <input type="text" id="s-nome" class="form-control" placeholder="Ex: João Corretor Imóveis" required>
            </div>
            <div class="form-group">
                <label class="form-label">CRECI *</label>
                <input type="text" id="s-creci" class="form-control" placeholder="Número do CRECI" required>
            </div>
            <div class="form-group">
                <label class="form-label">Telefone *</label>
                <input type="tel" id="s-telefone" class="form-control" oninput="Utils.maskPhone(this)" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" id="s-email" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Instagram (@)</label>
                <input type="text" id="s-instagram" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Endereço da Imobiliária</label>
                <textarea id="s-endereco" class="form-control" placeholder="Endereço completo..." rows="2"></textarea>
            </div>
            
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
            
            <div class="form-group">
                <label class="form-label">Notificar aniversários (dias antes)</label>
                <select id="s-notificar-aniversarios" class="form-control">
                    <option value="0">No dia</option>
                    <option value="1">1 dia antes</option>
                    <option value="3">3 dias antes</option>
                    <option value="7">1 semana antes</option>
                </select>
            </div>
            
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
            
            <button type="button" class="btn-block" style="background: var(--danger);" onclick="App.backup.clearData()">
                <i class="fas fa-trash"></i> Resetar Todos os Dados
            </button>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn-block" style="background: var(--secondary); margin: 0;" onclick="App.backup.importTrigger()">
                    <i class="fas fa-upload"></i> Importar
                </button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="App.backup.importData(this)">
                <button type="submit" class="btn-block" style="background: var(--primary); margin: 0;">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </form>
    </div>

    <script>
        // --- UTILITÁRIOS AVANÇADOS ---
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            
            formatCurrency: (val) => {
                if (!val) return 'R$ 0,00';
                return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            },
            
            parseCurrency: (str) => {
                if (!str) return 0;
                return parseFloat(str.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) || 0;
            },
            
            formatDate: (dateStr) => {
                if(!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            
            formatDateTime: (dateStr, timeStr = '') => {
                if(!dateStr) return '-';
                const date = new Date(dateStr + (timeStr ? 'T' + timeStr : ''));
                return date.toLocaleDateString('pt-BR') + (timeStr ? ' ' + timeStr : '');
            },
            
            maskPhone: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                input.value = v.substring(0, 15);
            },
            
            maskCPF: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                input.value = v.substring(0, 14);
            },
            
            maskMoney: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = (v / 100).toFixed(2) + "";
                v = v.replace(".", ",");
                v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                input.value = v ? 'R$ ' + v : '';
            },
            
            maskDecimal: (input) => {
                let v = input.value.replace(/[^\d,]/g, "");
                v = v.replace(",", ".");
                if(v.split(".").length > 2) {
                    v = v.substring(0, v.lastIndexOf("."));
                }
                v = v.replace(".", ",");
                input.value = v;
            },
            
            toast: (msg, type = 'success', duration = 3000) => {
                const t = document.getElementById('toast');
                const icon = type === 'success' ? 'check-circle' : 
                            type === 'error' ? 'exclamation-circle' : 
                            type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                
                t.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
                t.style.background = type === 'success' ? 'var(--success)' : 
                                   type === 'error' ? 'var(--danger)' : 
                                   type === 'warning' ? 'var(--warning)' : 'var(--primary)';
                t.classList.add('show');
                
                setTimeout(() => {
                    t.classList.remove('show');
                }, duration);
            },
            
            readImage: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            
            getToday: () => {
                const today = new Date();
                return today.toISOString().split('T')[0];
            },
            
            isToday: (dateStr) => {
                if(!dateStr) return false;
                return dateStr === Utils.getToday();
            },
            
            isPast: (dateStr) => {
                if(!dateStr) return false;
                return dateStr < Utils.getToday();
            },
            
            getSaudacao: () => {
                const hora = new Date().getHours();
                if (hora < 12) return "Bom dia";
                if (hora < 18) return "Boa tarde";
                return "Boa noite";
            },
            
            getStatusText: (status) => {
                const statusMap = {
                    'lead': 'Lead',
                    'prospect': 'Prospect',
                    'negotiation': 'Negociação',
                    'contract': 'Contrato',
                    'closed': 'Fechado',
                    'lost': 'Perdido'
                };
                return statusMap[status] || status;
            },
            
            getStatusColor: (status) => {
                const colorMap = {
                    'lead': 'warning',
                    'prospect': 'primary',
                    'negotiation': 'purple',
                    'contract': 'accent',
                    'closed': 'success',
                    'lost': 'danger'
                };
                return colorMap[status] || 'secondary';
            },
            
            getModalidadeText: (modalidade) => {
                const modalidadeMap = {
                    'pre-lancamento': 'Pré-lançamento',
                    'lancamento': 'Lançamento',
                    'em-obra': 'Em Obra',
                    'pronto': 'Pronto',
                    'lote': 'Lote'
                };
                return modalidadeMap[modalidade] || modalidade;
            },
            
            calcularTempoFunil: (cliente) => {
                if(!cliente.dataCadastro) return 0;
                const hoje = new Date();
                const cadastro = new Date(cliente.dataCadastro);
                const diffTime = Math.abs(hoje - cadastro);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            },
            
            calcularIdade: (nascimento) => {
                if(!nascimento) return null;
                const hoje = new Date();
                const nasc = new Date(nascimento);
                let idade = hoje.getFullYear() - nasc.getFullYear();
                const mes = hoje.getMonth() - nasc.getMonth();
                if (mes < 0 || (mes === 0 && hoje.getDate() < nasc.getDate())) {
                    idade--;
                }
                return idade;
            },
            
            formatPhoneForWhatsApp: (phone) => {
                return phone.replace(/\D/g, '');
            }
        };

        // --- STORAGE MANAGER ---
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(`imobim_pro_${key}`)) || [],
            set: (key, data) => localStorage.setItem(`imobim_pro_${key}`, JSON.stringify(data)),
            
            getSettings: () => {
                const defaultSettings = { 
                    nome: 'Corretor Imóveis',
                    creci: '00000',
                    telefone: '(00) 00000-0000',
                    email: 'corretor@email.com',
                    instagram: '@corretor',
                    endereco: 'Rua Exemplo, 123 - Centro\nCidade - Estado\nCEP: 00000-000',
                    logo: null,
                    msgLead: '{saudacao}, {nome}! Tudo bem? Me chamo {corretor} e gostaria de apresentar algumas oportunidades de imóveis que podem interessar a você. Posso te enviar mais informações?',
                    msgFollowup: '{saudacao}, {nome}! Espero que esteja bem. Estou entrando em contato para saber se ainda tem interesse nos imóveis que apresentei. Posso te ajudar com alguma dúvida?',
                    notificarAniversarios: '0',
                    tema: 'light'
                };
                
                const saved = JSON.parse(localStorage.getItem('imobim_pro_settings'));
                return { ...defaultSettings, ...saved };
            },
            
            saveSettings: (data) => localStorage.setItem('imobim_pro_settings', JSON.stringify(data)),
            
            getMetas: () => {
                const defaultMetas = {
                    metaLeads: 100,
                    convLeadsVisitas: 40,
                    convVisitasDocs: 50,
                    convDocsAprovacoes: 80,
                    convAprovacoesVendas: 75,
                    dataConfig: new Date().toISOString().split('T')[0]
                };
                
                const saved = JSON.parse(localStorage.getItem('imobim_pro_metas'));
                return { ...defaultMetas, ...saved };
            },
            
            saveMetas: (data) => localStorage.setItem('imobim_pro_metas', JSON.stringify(data)),
            
            getFunilEtapas: () => {
                const defaultEtapas = [
                    { id: '1', nome: 'Lead', cor: '#f59e0b', ordem: 1, descricao: 'Primeiro contato' },
                    { id: '2', nome: 'Prospect', cor: '#3b82f6', ordem: 2, descricao: 'Interessado qualificado' },
                    { id: '3', nome: 'Negociação', cor: '#8b5cf6', ordem: 3, descricao: 'Em negociação ativa' },
                    { id: '4', nome: 'Contrato', cor: '#10b981', ordem: 4, descricao: 'Contrato em análise' },
                    { id: '5', nome: 'Fechado', cor: '#0d9488', ordem: 5, descricao: 'Venda concluída' }
                ];
                
                const saved = JSON.parse(localStorage.getItem('imobim_pro_funil_etapas'));
                return saved || defaultEtapas;
            },
            
            saveFunilEtapas: (data) => localStorage.setItem('imobim_pro_funil_etapas', JSON.stringify(data))
        };

        // --- UI MANAGER ---
        const UI = {
            data: { 
                clientes: [], 
                imoveis: [], 
                agenda: [],
                metas: {},
                funilEtapas: []
            },
            
            currentFilterClientes: 'all',
            currentFilterImoveis: 'all',
            currentFilterAgenda: 'today',
            
            currentPhotoIndex: 0,
            currentPhotos: [],
            
            init: () => {
                // Carregar dados
                UI.data.clientes = Storage.get('clientes');
                UI.data.imoveis = Storage.get('imoveis');
                UI.data.agenda = Storage.get('agenda');
                UI.data.metas = Storage.getMetas();
                UI.data.funilEtapas = Storage.getFunilEtapas();
                
                // Aplicar tema salvo
                const settings = Storage.getSettings();
                if (settings.tema === 'dark') {
                    document.body.classList.add('dark-mode');
                }
                
                // Renderizar dashboard
                UI.renderDashboard();
                
                // Configurar listeners
                UI.setupEventListeners();
                
                // Verificar aniversários
                UI.checkAniversarios();
            },
            
            setupEventListeners: () => {
                // Tabs
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (!el.classList.contains('active')) {
                            UI.switchTab(el);
                        }
                    });
                });
                
                // Modals
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            UI.closeModals();
                        }
                    });
                });
                
                // Alteração de tipo de imóvel
                const tipoImovel = document.getElementById('i-tipo');
                if (tipoImovel) {
                    tipoImovel.addEventListener('change', App.imovel.toggleTipoFields);
                }
                
                // Configurar FAB dinâmico
                const fab = document.getElementById('main-fab');
                fab.addEventListener('click', () => {
                    const activeView = document.querySelector('.view.active').id;
                    if (activeView === 'clientes-view') {
                        UI.openNewCliente();
                    } else if (activeView === 'imoveis-view') {
                        UI.openNewImovel();
                    } else if (activeView === 'agenda-view') {
                        UI.openNewVisita();
                    } else {
                        UI.openNewCliente();
                    }
                });
            },
            
            switchTab: (el) => {
                // Remover classe active de todas as tabs
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                // Adicionar classe active na tab clicada
                el.classList.add('active');
                const target = el.getAttribute('data-target');
                document.getElementById(target).classList.add('active');
                
                // Atualizar FAB
                UI.updateFAB(target);
                
                // Renderizar conteúdo específico
                switch(target) {
                    case 'clientes-view':
                        UI.renderClientes();
                        break;
                    case 'imoveis-view':
                        UI.renderImoveis();
                        break;
                    case 'funil-view':
                        UI.renderFunil();
                        break;
                    case 'agenda-view':
                        UI.renderAgenda();
                        break;
                    case 'metas-view':
                        UI.renderMetas();
                        break;
                    case 'relatorios-view':
                        UI.renderRelatorios();
                        break;
                }
            },
            
            updateFAB: (viewId) => {
                const fab = document.getElementById('main-fab');
                let icon = 'plus';
                let onClick = UI.openNewCliente;
                
                switch(viewId) {
                    case 'clientes-view':
                        icon = 'user-plus';
                        onClick = UI.openNewCliente;
                        break;
                    case 'imoveis-view':
                        icon = 'home';
                        onClick = UI.openNewImovel;
                        break;
                    case 'agenda-view':
                        icon = 'calendar-plus';
                        onClick = UI.openNewVisita;
                        break;
                    case 'funil-view':
                        icon = 'plus';
                        onClick = UI.openNovaEtapaFunil;
                        break;
                    default:
                        icon = 'plus';
                        onClick = UI.openNewCliente;
                }
                
                fab.innerHTML = `<i class="fas fa-${icon}"></i>`;
                fab.onclick = onClick;
                fab.style.display = 'flex';
            },
            
            navigate: (tabName) => {
                const el = document.querySelector(`.nav-item[data-target="${tabName}-view"]`);
                if (el) UI.switchTab(el);
            },
            
            navigateToAgenda: (filter = 'today') => {
                UI.navigate('agenda');
                setTimeout(() => {
                    UI.filterAgenda(filter);
                }, 100);
            },
            
            // --- RENDER FUNCTIONS ---
            renderDashboard: () => {
                const { clientes, imoveis, agenda, metas } = UI.data;
                
                // Estatísticas básicas
                document.getElementById('dash-total-clientes').innerText = clientes.length;
                document.getElementById('dash-total-imoveis').innerText = imoveis.length;
                
                // Agenda para hoje
                const today = Utils.getToday();
                const agendaHoje = agenda.filter(a => a.data === today && a.status !== 'cancelado');
                document.getElementById('dash-agenda-hoje').innerText = agendaHoje.length;
                
                const agendaBadge = document.getElementById('agenda-badge');
                if (agendaHoje.length > 0) {
                    agendaBadge.style.display = 'inline-block';
                    agendaBadge.innerText = agendaHoje.length;
                } else {
                    agendaBadge.style.display = 'none';
                }
                
                // Vendas do mês
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();
                const vendasMes = clientes.filter(c => 
                    c.status === 'closed' && 
                    c.dataFechamento &&
                    c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                // Leads ativos
                const leadsAtivos = clientes.filter(c => 
                    c.status !== 'closed' && 
                    c.status !== 'lost' &&
                    (!c.dataCadastro || Utils.calcularTempoFunil(c) < 90)
                ).length;
                document.getElementById('dash-leads-ativos').innerText = leadsAtivos;
                
                // Receita do mês
                const receitaMes = clientes
                    .filter(c => c.status === 'closed' && c.valorVenda)
                    .reduce((acc, c) => acc + (c.valorVenda || 0), 0);
                document.getElementById('dash-receita-mes').innerText = Utils.formatCurrency(receitaMes);
                
                // Progresso das metas
                const progressoMetas = App.metas.calcularProgressoTotal();
                document.getElementById('dash-metas-progresso').innerText = `${Math.round(progressoMetas)}%`;
                document.getElementById('dash-metas-bar').style.width = `${progressoMetas}%`;
                
                // Render agenda para hoje
                UI.renderAgendaHoje(agendaHoje);
                
                // Render aniversariantes
                UI.renderAniversariantes();
                
                // Render follow-ups
                UI.renderFollowups();
                
                // Atualizar metas na dashboard
                UI.updateMetasDashboard();
            },
            
            renderAgendaHoje: (agendaHoje) => {
                const agendaList = document.getElementById('agenda-hoje-list');
                
                if (agendaHoje.length === 0) {
                    agendaList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <p>Nenhum agendamento para hoje!</p>
                        </div>`;
                } else {
                    agendaList.innerHTML = agendaHoje.map(a => UI.createAgendaCard(a, true)).join('');
                }
            },
            
            createAgendaCard: (a, isToday = false) => {
                const c = UI.data.clientes.find(cl => cl.id === a.clienteId) || { nome: 'Desconhecido' };
                let i = null;
                if (a.imovelId) {
                    i = UI.data.imoveis.find(im => im.id === a.imovelId);
                }
                
                let statusClass = '';
                if (a.status === 'cancelado') statusClass = 'tag-lost';
                else if (a.status === 'realizado') statusClass = 'tag-closed';
                else if (a.status === 'confirmado') statusClass = 'tag-contract';
                else statusClass = 'tag-scheduled';
                
                return `
                    <div class="list-card" onclick="UI.showAgendaDetails('${a.id}')">
                        <div class="card-header">
                            <div class="card-title">${a.tipo === 'visita' ? 'Visita' : a.tipo === 'reuniao' ? 'Reunião' : 'Agendamento'} - ${c.nome}</div>
                            <span class="tag ${statusClass}">${a.status === 'agendado' ? 'AGENDADO' : a.status.toUpperCase()}</span>
                        </div>
                        <div class="card-subtitle">
                            <i class="fas fa-calendar-day"></i> ${Utils.formatDateTime(a.data, a.horario)}
                            ${a.local ? `• ${a.local.substring(0, 20)}...` : ''}
                        </div>
                        ${i ? `<div class="card-subtitle"><i class="fas fa-home"></i> ${i.nome.substring(0, 30)}...</div>` : ''}
                        ${a.descricao ? `<div class="card-subtitle">${a.descricao.substring(0, 40)}...</div>` : ''}
                        <div class="action-row">
                            <button class="btn-sm btn-cyan" onclick="event.stopPropagation(); App.agenda.edit('${a.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> Zap
                            </button>
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); UI.showAgendaDetails('${a.id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                `;
            },
            
            renderAniversariantes: () => {
                const hoje = new Date();
                const diaHoje = hoje.getDate();
                const mesHoje = hoje.getMonth() + 1;
                
                const aniversariantes = UI.data.clientes.filter(c => {
                    if (!c.nascimento) return false;
                    const [ano, mes, dia] = c.nascimento.split('-');
                    return parseInt(dia) === diaHoje && parseInt(mes) === mesHoje;
                });
                
                const aniversariantesList = document.getElementById('aniversariantes-list');
                const aniversarioBadge = document.getElementById('aniversario-badge');
                
                if (aniversariantes.length > 0) {
                    aniversarioBadge.style.display = 'inline-block';
                    aniversarioBadge.innerText = aniversariantes.length;
                    
                    aniversariantesList.innerHTML = aniversariantes.map(c => `
                        <div class="list-card" onclick="UI.showClienteDetails('${c.id}')">
                            <div class="card-header">
                                <div class="card-title">${c.nome}</div>
                                <span class="tag tag-aniversario">
                                    <i class="fas fa-birthday-cake"></i> Aniversário!
                                </span>
                            </div>
                            <div class="card-subtitle">
                                <i class="fas fa-birthday-cake"></i> ${Utils.calcularIdade(c.nascimento)} anos hoje!
                            </div>
                            <div class="card-subtitle">
                                <i class="fas fa-phone"></i> ${c.telefone}
                            </div>
                            <div class="action-row">
                                <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.enviarParabens('${c.id}')">
                                    <i class="fab fa-whatsapp"></i> Parabenizar
                                </button>
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    aniversarioBadge.style.display = 'none';
                    aniversariantesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-birthday-cake"></i>
                            <p>Nenhum aniversariante hoje!</p>
                        </div>`;
                }
            },
            
            renderFollowups: () => {
                const followups = UI.data.clientes.filter(c => 
                    (c.status === 'lead' || c.status === 'prospect') &&
                    (!c.ultimoContato || Utils.isPast(c.ultimoContato)) &&
                    (!c.dataCadastro || Utils.calcularTempoFunil(c) >= 7)
                ).slice(0, 5);
                
                const followupList = document.getElementById('followup-list');
                const followupBadge = document.getElementById('followup-badge');
                
                if (followups.length > 0) {
                    followupBadge.style.display = 'inline-block';
                    followupBadge.innerText = followups.length;
                    
                    followupList.innerHTML = followups.map(c => UI.createFollowupCard(c)).join('');
                } else {
                    followupBadge.style.display = 'none';
                    followupList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-thumbs-up"></i>
                            <p>Nenhum follow-up necessário!</p>
                        </div>`;
                }
            },
            
            createFollowupCard: (c) => {
                const dias = Utils.calcularTempoFunil(c);
                let imoveisInfo = '';
                
                if (c.imoveisInteresse && c.imoveisInteresse.length > 0) {
                    const imovel = UI.data.imoveis.find(i => i.id === c.imoveisInteresse[0]);
                    if (imovel) {
                        imoveisInfo = `<div class="card-subtitle"><i class="fas fa-home"></i> Interesse: ${imovel.nome.substring(0, 30)}...</div>`;
                    }
                }
                
                return `
                    <div class="list-card" onclick="UI.showClienteDetails('${c.id}')">
                        <div class="card-header">
                            <div class="card-title">${c.nome}</div>
                            <span class="tag ${c.status === 'lead' ? 'tag-lead' : 'tag-prospect'}">
                                ${Utils.getStatusText(c.status)}
                            </span>
                        </div>
                        <div class="card-subtitle">
                            <i class="fas fa-phone"></i> ${c.telefone}
                        </div>
                        ${imoveisInfo}
                        <div class="card-subtitle">
                            <i class="fas fa-clock"></i> ${dias} dias sem contato
                        </div>
                        <div class="action-row">
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> Contatar
                            </button>
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                `;
            },
            
            updateMetasDashboard: () => {
                const metas = UI.data.metas;
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();
                
                // Calcular valores atuais
                const clientesMes = UI.data.clientes.filter(c => 
                    c.dataCadastro && 
                    c.dataCadastro.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                const vendasMes = UI.data.clientes.filter(c => 
                    c.status === 'closed' && 
                    c.dataFechamento &&
                    c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                const receitaMes = UI.data.clientes
                    .filter(c => c.status === 'closed' && c.valorVenda && c.dataFechamento && c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`))
                    .reduce((acc, c) => acc + (c.valorVenda || 0), 0);
                
                const visitasMes = UI.data.agenda.filter(a => 
                    a.tipo === 'visita' && 
                    a.data &&
                    a.data.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                // Atualizar valores
                document.getElementById('meta-vendas-atual').innerText = vendasMes;
                document.getElementById('meta-vendas-total').innerText = metas.metaLeads || 0;
                
                document.getElementById('meta-receita-atual').innerText = Utils.formatCurrency(receitaMes);
                document.getElementById('meta-receita-total').innerText = Utils.formatCurrency(metas.metaReceita || 0);
                
                document.getElementById('meta-clientes-atual').innerText = clientesMes;
                document.getElementById('meta-clientes-total').innerText = metas.metaNovosClientes || 0;
                
                document.getElementById('meta-visitas-atual').innerText = visitasMes;
                document.getElementById('meta-visitas-total').innerText = metas.metaVisitas || 0;
                
                // Atualizar barras de progresso
                const progressoVendas = metas.metaLeads > 0 ? Math.min((vendasMes / metas.metaLeads) * 100, 100) : 0;
                const progressoReceita = metas.metaReceita > 0 ? Math.min((receitaMes / metas.metaReceita) * 100, 100) : 0;
                const progressoClientes = metas.metaNovosClientes > 0 ? Math.min((clientesMes / metas.metaNovosClientes) * 100, 100) : 0;
                const progressoVisitas = metas.metaVisitas > 0 ? Math.min((visitasMes / metas.metaVisitas) * 100, 100) : 0;
                
                document.getElementById('meta-vendas-bar').style.width = `${progressoVendas}%`;
                document.getElementById('meta-receita-bar').style.width = `${progressoReceita}%`;
                document.getElementById('meta-clientes-bar').style.width = `${progressoClientes}%`;
                document.getElementById('meta-visitas-bar').style.width = `${progressoVisitas}%`;
            },
            
            // --- RENDER CLIENTES ---
            renderClientes: (filter = '') => {
                const list = document.getElementById('clientes-list');
                let filtered = UI.getFilteredClientes(UI.currentFilterClientes);
                
                if (filter) {
                    filtered = filtered.filter(c => 
                        c.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        c.telefone.includes(filter) ||
                        c.email?.toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <p>Nenhum cliente encontrado.</p>
                        </div>`;
                } else {
                    list.innerHTML = filtered.map(c => UI.createClienteCard(c)).join('');
                }
            },
            
            getFilteredClientes: (filterType) => {
                let filtered = [...UI.data.clientes];
                
                if (filterType !== 'all') {
                    filtered = filtered.filter(c => c.status === filterType);
                }
                
                return filtered.sort((a, b) => {
                    if (a.status === b.status) {
                        return new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0);
                    }
                    return a.status.localeCompare(b.status);
                });
            },
            
            filterClientes: (filterType) => {
                UI.currentFilterClientes = filterType;
                UI.updateFilterButtons('clientes-view', filterType);
                UI.renderClientes();
            },
            
            createClienteCard: (c) => {
                let statusTag = '';
                const statusColor = Utils.getStatusColor(c.status);
                statusTag = `<span class="tag tag-${statusColor}">${Utils.getStatusText(c.status)}</span>`;
                
                let imoveisInfo = '';
                if (c.imoveisInteresse && c.imoveisInteresse.length > 0) {
                    const count = c.imoveisInteresse.length;
                    imoveisInfo = `<div class="card-subtitle"><i class="fas fa-home"></i> ${count} imóvel${count > 1 ? 'eis' : ''} de interesse</div>`;
                }
                
                // Verificar se é aniversário
                const hoje = new Date();
                const [ano, mes, dia] = c.nascimento ? c.nascimento.split('-') : [null, null, null];
                const isAniversario = mes && dia && parseInt(mes) === hoje.getMonth() + 1 && parseInt(dia) === hoje.getDate();
                
                return `
                    <div class="list-card" onclick="UI.showClienteDetails('${c.id}')">
                        <div class="card-header">
                            <div class="card-title">${c.nome} ${isAniversario ? '🎂' : ''}</div>
                            ${statusTag}
                        </div>
                        <div class="card-subtitle">
                            <i class="fas fa-phone"></i> ${c.telefone}
                        </div>
                        ${c.email ? `<div class="card-subtitle"><i class="fas fa-envelope"></i> ${c.email}</div>` : ''}
                        ${imoveisInfo}
                        ${c.renda ? `<div class="card-price">Renda: ${Utils.formatCurrency(c.renda)}</div>` : ''}
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> Zap
                            </button>
                            <button class="btn-sm btn-purple" onclick="event.stopPropagation(); UI.openNewVisitaForCliente('${c.id}')">
                                <i class="fas fa-calendar-plus"></i> Agendar
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // --- RENDER IMÓVEIS ---
            renderImoveis: (filter = '') => {
                const list = document.getElementById('imoveis-list');
                let filtered = UI.getFilteredImoveis(UI.currentFilterImoveis);
                
                if (filter) {
                    filtered = filtered.filter(i => 
                        i.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        i.localizacao?.toLowerCase().includes(filter.toLowerCase()) ||
                        i.construtora?.toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-building"></i>
                            <p>Nenhum imóvel encontrado.</p>
                        </div>`;
                } else {
                    list.innerHTML = filtered.map(i => UI.createImovelCard(i)).join('');
                }
            },
            
            getFilteredImoveis: (filterType) => {
                let filtered = [...UI.data.imoveis];
                
                switch(filterType) {
                    case 'pre-lancamento':
                        filtered = filtered.filter(i => i.modalidade === 'pre-lancamento');
                        break;
                    case 'lancamento':
                        filtered = filtered.filter(i => i.modalidade === 'lancamento');
                        break;
                    case 'em-obra':
                        filtered = filtered.filter(i => i.modalidade === 'em-obra');
                        break;
                    case 'pronto':
                        filtered = filtered.filter(i => i.modalidade === 'pronto');
                        break;
                    case 'lote':
                        filtered = filtered.filter(i => i.modalidade === 'lote' || i.tipo === 'lote');
                        break;
                    case 'vendido':
                        filtered = filtered.filter(i => i.status === 'vendido');
                        break;
                    case 'disponivel':
                        filtered = filtered.filter(i => i.status === 'disponivel');
                        break;
                }
                
                return filtered.sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
            },
            
            filterImoveis: (filterType) => {
                UI.currentFilterImoveis = filterType;
                UI.updateFilterButtons('imoveis-view', filterType);
                UI.renderImoveis();
            },
            
            createImovelCard: (i) => {
                let modalidadeTag = '';
                switch(i.modalidade) {
                    case 'pre-lancamento':
                        modalidadeTag = `<span class="tag tag-pre-lancamento">PRÉ-LANÇAMENTO</span>`;
                        break;
                    case 'lancamento':
                        modalidadeTag = `<span class="tag tag-lancamento">LANÇAMENTO</span>`;
                        break;
                    case 'em-obra':
                        modalidadeTag = `<span class="tag tag-em-obra">EM OBRA</span>`;
                        break;
                    case 'pronto':
                        modalidadeTag = `<span class="tag tag-pronto">PRONTO</span>`;
                        break;
                    case 'lote':
                        modalidadeTag = `<span class="tag tag-lote">LOTE</span>`;
                        break;
                }
                
                let statusTag = '';
                if (i.status === 'vendido') {
                    statusTag = `<span class="tag tag-closed">VENDIDO</span>`;
                } else if (i.status === 'reservado') {
                    statusTag = `<span class="tag tag-negotiation">RESERVADO</span>`;
                }
                
                // Foto do imóvel
                let fotoHTML = '';
                if (i.fotos && i.fotos.length > 0) {
                    fotoHTML = `
                        <div style="position: relative; margin: -20px -20px 15px -20px; border-radius: var(--radius-md) var(--radius-md) 0 0; overflow: hidden;">
                            <img src="${i.fotos[0]}" style="width: 100%; height: 160px; object-fit: cover; cursor: pointer;" onclick="event.stopPropagation(); UI.openPhotoFullscreen('${i.id}', 0)">
                            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">
                                <i class="fas fa-camera"></i> ${i.fotos.length}
                            </div>
                        </div>`;
                }
                
                let detalhes = '';
                if (i.tipo === 'lote') {
                    detalhes = `<div class="card-subtitle"><i class="fas fa-ruler-combined"></i> ${i.area || '0'} m²</div>`;
                } else {
                    detalhes = `<div class="card-subtitle">
                        ${i.quartos ? `<i class="fas fa-bed"></i> ${i.quartos} quartos` : ''}
                        ${i.banheiros ? ` • ${i.banheiros} banheiros` : ''}
                        ${i.vagas ? ` • ${i.vagas} vagas` : ''}
                        ${i.area ? ` • ${i.area} m²` : ''}
                    </div>`;
                }
                
                return `
                    <div class="list-card" onclick="UI.showImovelDetails('${i.id}')">
                        ${fotoHTML}
                        <div class="card-header" style="${i.fotos && i.fotos.length > 0 ? 'margin-top: 0;' : ''}">
                            <div class="card-title">${i.nome}</div>
                            <div style="display: flex; gap: 4px;">
                                ${modalidadeTag}
                                ${statusTag}
                            </div>
                        </div>
                        ${detalhes}
                        <div class="card-subtitle">
                            <i class="fas fa-map-marker-alt"></i> ${i.localizacao ? i.localizacao.substring(0, 30) + (i.localizacao.length > 30 ? '...' : '') : 'Localização não informada'}
                        </div>
                        ${i.construtora ? `<div class="card-subtitle"><i class="fas fa-industry"></i> ${i.construtora}</div>` : ''}
                        <div class="card-price">${Utils.formatCurrency(i.valor)}</div>
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.imovel.edit('${i.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-sm btn-primary" onclick="event.stopPropagation(); UI.openNewVisitaForImovel('${i.id}')">
                                <i class="fas fa-calendar-plus"></i> Visita
                            </button>
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.shareImovel('${i.id}')">
                                <i class="fab fa-whatsapp"></i> Compartilhar
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // --- RENDER FUNIL ---
            renderFunil: () => {
                const etapas = UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem);
                const container = document.getElementById('funnel-stages-container');
                
                container.innerHTML = '';
                
                etapas.forEach(etapa => {
                    const clientesNaEtapa = UI.data.clientes.filter(c => c.status === etapa.id);
                    
                    const etapaHTML = `
                        <div class="funnel-stage">
                            <div class="funnel-stage-header" style="border-color: ${etapa.cor};">
                                <div class="funnel-stage-title" style="color: ${etapa.cor};">${etapa.nome}</div>
                                <div class="funnel-stage-count">${clientesNaEtapa.length}</div>
                            </div>
                            <div id="funnel-${etapa.id}">
                                ${clientesNaEtapa.map(c => `
                                    <div class="funnel-lead-item" onclick="UI.showClienteDetails('${c.id}')">
                                        <div style="font-weight: 600; font-size: 0.9rem;">${c.nome}</div>
                                        <div style="font-size: 0.7rem; color: var(--secondary);">
                                            ${Utils.calcularTempoFunil(c)} dias
                                            ${c.ultimoContato ? `• Último: ${Utils.formatDate(c.ultimoContato)}` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 8px;">
                                <button class="btn-sm btn-light" style="flex: 1;" onclick="UI.editarEtapaFunil('${etapa.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-sm btn-danger" onclick="App.funil.deleteEtapa('${etapa.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML += etapaHTML;
                });
                
                // Calcular estatísticas
                UI.calcularEstatisticasFunil();
            },
            
            calcularEstatisticasFunil: () => {
                const clientes = UI.data.clientes;
                const totalClientes = clientes.length;
                const totalFechados = clientes.filter(c => c.status === 'closed').length;
                const totalPerdidos = clientes.filter(c => c.status === 'lost').length;
                
                const taxaConversao = totalClientes > 0 ? Math.round((totalFechados / totalClientes) * 100) : 0;
                
                // Tempo médio no funil (apenas para fechados)
                let tempoMedio = 0;
                const fechados = clientes.filter(c => c.status === 'closed');
                if (fechados.length > 0) {
                    const tempos = fechados.map(c => Utils.calcularTempoFunil(c));
                    tempoMedio = Math.round(tempos.reduce((a, b) => a + b, 0) / tempos.length);
                }
                
                // Valor médio das vendas
                const valorMedio = fechados.length > 0 ? 
                    fechados.reduce((acc, c) => acc + (c.valorVenda || 0), 0) / fechados.length : 0;
                
                document.getElementById('funil-taxa-conversao').innerText = `${taxaConversao}%`;
                document.getElementById('funil-tempo-medio').innerText = `${tempoMedio} dias`;
                document.getElementById('funil-valor-medio').innerText = Utils.formatCurrency(valorMedio);
                document.getElementById('funil-perdidos').innerText = totalPerdidos;
            },
            
            // --- RENDER AGENDA ---
            renderAgenda: (filter = '') => {
                const list = document.getElementById('agenda-list');
                let filtered = UI.getFilteredAgenda(UI.currentFilterAgenda);
                
                if (filter) {
                    filtered = filtered.filter(a => {
                        const c = UI.data.clientes.find(cl => cl.id === a.clienteId);
                        const cName = c ? c.nome.toLowerCase() : '';
                        const i = a.imovelId ? UI.data.imoveis.find(im => im.id === a.imovelId) : null;
                        const iName = i ? i.nome.toLowerCase() : '';
                        return cName.includes(filter.toLowerCase()) || 
                               iName.includes(filter.toLowerCase()) ||
                               a.local?.toLowerCase().includes(filter.toLowerCase());
                    });
                }
                
                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <p>Nenhum agendamento encontrado.</p>
                        </div>`;
                } else {
                    list.innerHTML = filtered.map(a => UI.createAgendaCard(a)).join('');
                }
            },
            
            getFilteredAgenda: (filterType) => {
                let filtered = [...UI.data.agenda];
                const today = Utils.getToday();
                const hoje = new Date();
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);
                
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                
                switch(filterType) {
                    case 'today':
                        filtered = filtered.filter(a => a.data === today);
                        break;
                    case 'week':
                        filtered = filtered.filter(a => {
                            const data = new Date(a.data);
                            return data >= inicioSemana && data <= fimSemana;
                        });
                        break;
                    case 'month':
                        filtered = filtered.filter(a => {
                            const data = new Date(a.data);
                            return data >= inicioMes && data <= fimMes;
                        });
                        break;
                    case 'visita':
                        filtered = filtered.filter(a => a.tipo === 'visita');
                        break;
                    case 'reuniao':
                        filtered = filtered.filter(a => a.tipo === 'reuniao');
                        break;
                    case 'assinatura':
                        filtered = filtered.filter(a => a.tipo === 'assinatura');
                        break;
                    case 'plantao':
                        filtered = filtered.filter(a => a.tipo === 'plantao');
                        break;
                }
                
                return filtered.sort((a, b) => {
                    if (a.data === b.data) {
                        return a.horario.localeCompare(b.horario);
                    }
                    return a.data.localeCompare(b.data);
                });
            },
            
            filterAgenda: (filterType) => {
                UI.currentFilterAgenda = filterType;
                UI.updateFilterButtons('agenda-view', filterType);
                UI.renderAgenda();
            },
            
            // --- RENDER METAS ---
            renderMetas: () => {
                const metas = UI.data.metas;
                
                // Preencher configuração de metas
                document.getElementById('config-meta-leads').value = metas.metaLeads || 100;
                document.getElementById('config-conv-leads-visitas').value = metas.convLeadsVisitas || 40;
                document.getElementById('config-conv-visitas-docs').value = metas.convVisitasDocs || 50;
                document.getElementById('config-conv-docs-aprovacoes').value = metas.convDocsAprovacoes || 80;
                document.getElementById('config-conv-aprovacoes-vendas').value = metas.convAprovacoesVendas || 75;
                
                // Calcular e mostrar análise de performance
                UI.showPerformanceAnalysis();
                
                // Calcular progressos individuais
                UI.calcularProgressosMetas();
            },
            
            showPerformanceAnalysis: () => {
                const metas = UI.data.metas;
                const hoje = new Date();
                const totalDiasMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
                const diasPassados = hoje.getDate();
                
                const metaVendas = metas.metaLeads || 0;
                const tendenciaVendas = App.metas.calcularTendencia();
                
                const performanceDiv = document.getElementById('performance-analysis');
                
                if (tendenciaVendas >= metaVendas) {
                    performanceDiv.innerHTML = `
                        <div style="background: linear-gradient(135deg, var(--success-light), var(--success)); padding: 20px; border-radius: var(--radius-md); color: white; text-align: center;">
                            <i class="fas fa-trophy" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                            <h3 style="margin-bottom: 10px; font-size: 1.3rem;">🎉 Desempenho Excelente!</h3>
                            <p style="margin-bottom: 15px;">Sua tendência de vendas (${Math.round(tendenciaVendas)} vendas) está superando a meta de ${metaVendas} vendas.</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                                    ${diasPassados}/${totalDiasMes} dias
                                </span>
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                                    ${Math.round((diasPassados/totalDiasMes)*100)}% do mês
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    const estrategias = [
                        "Reativar leads antigos com uma nova oferta ou informação de mercado.",
                        "Aumentar o networking participando de eventos locais (online ou presenciais).",
                        "Pedir indicações para clientes satisfeitos da sua carteira.",
                        "Criar conteúdo de valor nas redes sociais sobre o mercado imobiliário local.",
                        "Focar em um nicho de mercado específico (ex: imóveis de luxo, primeiro imóvel).",
                        "Realizar campanhas de e-mail marketing segmentadas para sua base de contatos."
                    ];
                    
                    const estrategiasSelecionadas = estrategias.sort(() => 0.5 - Math.random()).slice(0, 3);
                    
                    performanceDiv.innerHTML = `
                        <div style="background: linear-gradient(135deg, var(--warning-light), var(--warning)); padding: 20px; border-radius: var(--radius-md); color: #7c2d12; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                            <h3 style="margin-bottom: 10px; font-size: 1.3rem; color: #7c2d12;">⚠️ Oportunidade de Melhoria</h3>
                            <p style="margin-bottom: 15px; color: #7c2d12;">Sua tendência atual é de ${Math.round(tendenciaVendas)} vendas, abaixo da meta de ${metaVendas} vendas.</p>
                            
                            <div style="text-align: left; margin-top: 20px;">
                                <h4 style="margin-bottom: 10px; color: #7c2d12;">Estratégias Sugeridas:</h4>
                                <ul style="list-style: none; padding: 0;">
                                    ${estrategiasSelecionadas.map(e => `
                                        <li style="padding: 10px; background: rgba(255,255,255,0.3); border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 4px solid var(--warning);">
                                            ${e}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
            },
            
            calcularProgressosMetas: () => {
                const metas = UI.data.metas;
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();
                
                // Calcular valores atuais
                const leadsMes = UI.data.clientes.filter(c => 
                    c.dataCadastro && 
                    c.dataCadastro.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                const visitasMes = UI.data.agenda.filter(a => 
                    a.tipo === 'visita' && 
                    a.data &&
                    a.data.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                const docsMes = UI.data.clientes.filter(c => 
                    c.status === 'contract' && 
                    c.dataContrato &&
                    c.dataContrato.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                const aprovacoesMes = UI.data.clientes.filter(c => 
                    c.status === 'closed' && 
                    c.dataFechamento &&
                    c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                
                // Calcular metas esperadas
                const metaLeadsEsperada = metas.metaLeads || 0;
                const metaVisitasEsperada = metaLeadsEsperada * (metas.convLeadsVisitas / 100);
                const metaDocsEsperada = metaVisitasEsperada * (metas.convVisitasDocs / 100);
                const metaAprovacoesEsperada = metaDocsEsperada * (metas.convDocsAprovacoes / 100);
                const metaVendasEsperada = metaAprovacoesEsperada * (metas.convAprovacoesVendas / 100);
                
                // Calcular progressos
                const progressoLeads = metaLeadsEsperada > 0 ? Math.min((leadsMes / metaLeadsEsperada) * 100, 100) : 0;
                const progressoVisitas = metaVisitasEsperada > 0 ? Math.min((visitasMes / metaVisitasEsperada) * 100, 100) : 0;
                const progressoDocs = metaDocsEsperada > 0 ? Math.min((docsMes / metaDocsEsperada) * 100, 100) : 0;
                const progressoAprovacoes = metaAprovacoesEsperada > 0 ? Math.min((aprovacoesMes / metaAprovacoesEsperada) * 100, 100) : 0;
                
                // Atualizar elementos
                document.getElementById('meta-progresso-leads').innerText = `${Math.round(progressoLeads)}%`;
                document.getElementById('meta-progresso-visitas').innerText = `${Math.round(progressoVisitas)}%`;
                document.getElementById('meta-progresso-docs').innerText = `${Math.round(progressoDocs)}%`;
                document.getElementById('meta-progresso-aprovacoes').innerText = `${Math.round(progressoAprovacoes)}%`;
                
                document.getElementById('meta-bar-leads').style.width = `${progressoLeads}%`;
                document.getElementById('meta-bar-visitas').style.width = `${progressoVisitas}%`;
                document.getElementById('meta-bar-docs').style.width = `${progressoDocs}%`;
                document.getElementById('meta-bar-aprovacoes').style.width = `${progressoAprovacoes}%`;
            },
            
            // --- RENDER RELATÓRIOS ---
            renderRelatorios: () => {
                // Esta função pode ser expandida para pré-visualizar dados de relatórios
            },
            
            // --- MODAL FUNCTIONS ---
            openModal: (type) => {
                document.getElementById(`overlay-${type}`).classList.add('active');
            },
            
            closeModals: () => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            },
            
            openNewCliente: () => {
                // Carregar imóveis para a lista de interesse
                const imoveisList = document.getElementById('c-imoveis-interesse-list');
                imoveisList.innerHTML = '';
                
                UI.data.imoveis.forEach(i => {
                    if (i.status !== 'vendido') {
                        imoveisList.innerHTML += `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border);">
                                <input type="checkbox" id="imovel-${i.id}" value="${i.id}" style="width: 18px; height: 18px;">
                                <label for="imovel-${i.id}" style="flex: 1; cursor: pointer;">
                                    <div style="font-weight: 600; font-size: 0.9rem;">${i.nome}</div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">${Utils.formatCurrency(i.valor)}</div>
                                </label>
                            </div>
                        `;
                    }
                });
                
                // Limpar formulário
                document.getElementById('form-cliente').reset();
                document.getElementById('c-id').value = '';
                document.getElementById('title-cliente').innerText = 'Novo Cliente';
                document.getElementById('c-nascimento').max = new Date().toISOString().split('T')[0];
                
                UI.openModal('cliente');
            },
            
            openNewImovel: () => {
                // Limpar fotos anteriores
                App.imovel.fotos = [];
                App.imovel.renderFotos();
                
                // Limpar formulário
                document.getElementById('form-imovel').reset();
                document.getElementById('i-id').value = '';
                document.getElementById('title-imovel').innerText = 'Novo Imóvel';
                
                // Mostrar campos apropriados
                App.imovel.toggleTipoFields();
                
                UI.openModal('imovel');
            },
            
            openNewVisita: () => {
                const selectCliente = document.getElementById('av-cliente');
                const selectImovel = document.getElementById('av-imovel');
                
                // Carregar clientes
                selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                UI.data.clientes.forEach(c => {
                    selectCliente.innerHTML += `<option value="${c.id}">${c.nome} - ${c.telefone}</option>`;
                });
                
                // Carregar imóveis
                selectImovel.innerHTML = '<option value="">Selecione um imóvel...</option>';
                UI.data.imoveis.forEach(i => {
                    if (i.status !== 'vendido') {
                        selectImovel.innerHTML += `<option value="${i.id}">${i.nome} - ${Utils.formatCurrency(i.valor)}</option>`;
                    }
                });
                
                // Definir data para hoje
                document.getElementById('av-data').value = Utils.getToday();
                document.getElementById('av-data').min = Utils.getToday();
                
                document.getElementById('form-agenda-visita').reset();
                document.getElementById('av-id').value = '';
                
                UI.openModal('agenda-visita');
            },
            
            openNewVisitaForCliente: (clienteId) => {
                UI.closeModals();
                setTimeout(() => {
                    UI.openNewVisita();
                    setTimeout(() => {
                        document.getElementById('av-cliente').value = clienteId;
                    }, 100);
                }, 300);
            },
            
            openNewVisitaForImovel: (imovelId) => {
                UI.closeModals();
                setTimeout(() => {
                    UI.openNewVisita();
                    setTimeout(() => {
                        document.getElementById('av-imovel').value = imovelId;
                    }, 100);
                }, 300);
            },
            
            openNewReuniao: () => {
                const selectCliente = document.getElementById('ar-cliente');
                
                // Carregar clientes
                selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                UI.data.clientes.forEach(c => {
                    selectCliente.innerHTML += `<option value="${c.id}">${c.nome} - ${c.telefone}</option>`;
                });
                
                // Definir data para hoje
                document.getElementById('ar-data').value = Utils.getToday();
                document.getElementById('ar-data').min = Utils.getToday();
                
                document.getElementById('form-agenda-reuniao').reset();
                document.getElementById('ar-id').value = '';
                
                UI.openModal('agenda-reuniao');
            },
            
            openNovaEtapaFunil: () => {
                document.getElementById('form-etapa-funil').reset();
                document.getElementById('etapa-id').value = '';
                document.getElementById('title-etapa-funil').innerText = 'Nova Etapa do Funil';
                document.getElementById('etapa-ordem').value = UI.data.funilEtapas.length + 1;
                
                UI.openModal('etapa-funil');
            },
            
            editarEtapaFunil: (id) => {
                const etapa = UI.data.funilEtapas.find(e => e.id === id);
                if (!etapa) return;
                
                document.getElementById('etapa-id').value = etapa.id;
                document.getElementById('etapa-nome').value = etapa.nome;
                document.getElementById('etapa-cor').value = etapa.cor;
                document.getElementById('etapa-ordem').value = etapa.ordem;
                document.getElementById('etapa-descricao').value = etapa.descricao || '';
                document.getElementById('title-etapa-funil').innerText = 'Editar Etapa do Funil';
                
                UI.openModal('etapa-funil');
            },
            
            openMetasConfig: () => {
                UI.openModal('settings');
            },
            
            openSettings: () => {
                const s = Storage.getSettings();
                
                document.getElementById('s-nome').value = s.nome || '';
                document.getElementById('s-creci').value = s.creci || '';
                document.getElementById('s-telefone').value = s.telefone || '';
                document.getElementById('s-email').value = s.email || '';
                document.getElementById('s-instagram').value = s.instagram || '';
                document.getElementById('s-endereco').value = s.endereco || '';
                document.getElementById('s-notificar-aniversarios').value = s.notificarAniversarios || '0';
                
                // Logo
                document.getElementById('s-logo-data').value = s.logo || '';
                if (s.logo) {
                    document.getElementById('s-logo-preview').src = s.logo;
                    document.getElementById('s-logo-preview').style.display = 'block';
                    document.getElementById('s-logo-placeholder').style.display = 'none';
                } else {
                    document.getElementById('s-logo-preview').style.display = 'none';
                    document.getElementById('s-logo-placeholder').style.display = 'flex';
                }
                
                UI.openModal('settings');
            },
            
            // --- FOTO FULLSCREEN ---
            openPhotoFullscreen: (imovelId, index) => {
                const i = UI.data.imoveis.find(x => x.id === imovelId);
                if (!i || !i.fotos || i.fotos.length === 0) return;
                
                UI.currentPhotos = i.fotos;
                UI.currentPhotoIndex = index;
                
                document.getElementById('fullscreen-photo').src = UI.currentPhotos[UI.currentPhotoIndex];
                document.getElementById('photo-counter').innerText = `${UI.currentPhotoIndex + 1} / ${UI.currentPhotos.length}`;
                document.getElementById('photo-fullscreen').classList.remove('hidden');
            },
            
            closePhotoFullscreen: () => {
                document.getElementById('photo-fullscreen').classList.add('hidden');
                UI.currentPhotos = [];
                UI.currentPhotoIndex = 0;
            },
            
            nextPhoto: () => {
                if (UI.currentPhotos.length === 0) return;
                
                UI.currentPhotoIndex = (UI.currentPhotoIndex + 1) % UI.currentPhotos.length;
                document.getElementById('fullscreen-photo').src = UI.currentPhotos[UI.currentPhotoIndex];
                document.getElementById('photo-counter').innerText = `${UI.currentPhotoIndex + 1} / ${UI.currentPhotos.length}`;
            },
            
            prevPhoto: () => {
                if (UI.currentPhotos.length === 0) return;
                
                UI.currentPhotoIndex = (UI.currentPhotoIndex - 1 + UI.currentPhotos.length) % UI.currentPhotos.length;
                document.getElementById('fullscreen-photo').src = UI.currentPhotos[UI.currentPhotoIndex];
                document.getElementById('photo-counter').innerText = `${UI.currentPhotoIndex + 1} / ${UI.currentPhotos.length}`;
            },
            
            // --- DETALHES ---
            showClienteDetails: (id) => {
                const c = UI.data.clientes.find(x => x.id === id);
                if (!c) return;
                
                const imoveisInteresse = c.imoveisInteresse ? 
                    c.imoveisInteresse.map(imovelId => 
                        UI.data.imoveis.find(i => i.id === imovelId)
                    ).filter(Boolean) : [];
                
                const agendamentosCliente = UI.data.agenda.filter(a => a.clienteId === id);
                
                let statusBadge = '';
                const statusColor = Utils.getStatusColor(c.status);
                statusBadge = `<span class="badge badge-${statusColor}">${Utils.getStatusText(c.status)}</span>`;
                
                // Verificar aniversário
                const idade = Utils.calcularIdade(c.nascimento);
                const aniversarioInfo = c.nascimento ? `
                    <div class="info-item">
                        <div class="info-label">Data Nascimento</div>
                        <div class="info-value">${Utils.formatDate(c.nascimento)} ${idade ? `(${idade} anos)` : ''}</div>
                    </div>
                ` : '';
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div>
                                <div class="details-title">${c.nome}</div>
                                <div class="details-subtitle">Cliente desde: ${Utils.formatDate(c.dataCadastro || new Date().toISOString().split('T')[0])}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-info-circle"></i> INFORMAÇÕES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Telefone</div>
                                    <div class="info-value">${c.telefone}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${c.email || '-'}</div>
                                </div>
                                ${c.cpf ? `
                                <div class="info-item">
                                    <div class="info-label">CPF</div>
                                    <div class="info-value">${c.cpf}</div>
                                </div>
                                ` : ''}
                                ${aniversarioInfo}
                                ${c.renda ? `
                                <div class="info-item">
                                    <div class="info-label">Renda Mensal</div>
                                    <div class="info-value">${Utils.formatCurrency(c.renda)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${imoveisInteresse.length > 0 ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-home"></i> IMÓVEIS DE INTERESSE (${imoveisInteresse.length})</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${imoveisInteresse.map(i => `
                                    <div class="list-card" style="margin-bottom: 8px;" onclick="UI.showImovelDetails('${i.id}')">
                                        <div class="card-header">
                                            <div class="card-title">${i.nome}</div>
                                            <span class="tag ${i.modalidade === 'lote' ? 'tag-lote' : (i.modalidade === 'pronto' ? 'tag-pronto' : 'tag-pre-lancamento')}">
                                                ${Utils.getModalidadeText(i.modalidade)}
                                            </span>
                                        </div>
                                        <div class="card-subtitle">${Utils.formatCurrency(i.valor)} • ${i.localizacao ? i.localizacao.substring(0, 30) + '...' : ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${agendamentosCliente.length > 0 ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-calendar-alt"></i> ÚLTIMOS AGENDAMENTOS (${agendamentosCliente.length})</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${agendamentosCliente.slice(0, 3).map(a => `
                                    <div class="list-card" style="margin-bottom: 8px;" onclick="UI.showAgendaDetails('${a.id}')">
                                        <div class="card-header">
                                            <div class="card-title">${a.tipo === 'visita' ? 'Visita' : 'Reunião'}</div>
                                            <span class="tag ${a.status === 'realizado' ? 'tag-closed' : (a.status === 'cancelado' ? 'tag-lost' : 'tag-scheduled')}">
                                                ${a.status.toUpperCase()}
                                            </span>
                                        </div>
                                        <div class="card-subtitle">${Utils.formatDateTime(a.data, a.horario)} • ${a.local || 'Local não informado'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${c.observacoes ? `
                        <div class="private-notes">
                            <div class="private-notes-label"><i class="fas fa-sticky-note"></i> OBSERVAÇÕES</div>
                            <div class="private-notes-content">${c.observacoes}</div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.cliente.gerarFichaPDF('${c.id}')">
                                <i class="fas fa-file-pdf"></i> Ficha PDF
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="App.cliente.edit('${c.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('cliente-details-content').innerHTML = detailsContent;
                UI.openModal('cliente-details');
            },
            
            showImovelDetails: (id) => {
                const i = UI.data.imoveis.find(x => x.id === id);
                if (!i) return;
                
                const clientesInteressados = UI.data.clientes.filter(c => 
                    c.imoveisInteresse && c.imoveisInteresse.includes(id)
                );
                
                let modalidadeBadge = '';
                switch(i.modalidade) {
                    case 'pre-lancamento':
                        modalidadeBadge = `<span class="badge badge-cyan">PRÉ-LANÇAMENTO</span>`;
                        break;
                    case 'lancamento':
                        modalidadeBadge = `<span class="badge badge-primary">LANÇAMENTO</span>`;
                        break;
                    case 'em-obra':
                        modalidadeBadge = `<span class="badge badge-warning">EM OBRA</span>`;
                        break;
                    case 'pronto':
                        modalidadeBadge = `<span class="badge badge-success">PRONTO</span>`;
                        break;
                    case 'lote':
                        modalidadeBadge = `<span class="badge badge-secondary">LOTE</span>`;
                        break;
                }
                
                let statusBadge = '';
                if (i.status === 'vendido') {
                    statusBadge = `<span class="badge badge-success">VENDIDO</span>`;
                } else if (i.status === 'reservado') {
                    statusBadge = `<span class="badge badge-warning">RESERVADO</span>`;
                } else {
                    statusBadge = `<span class="badge badge-primary">DISPONÍVEL</span>`;
                }
                
                // Fotos
                let fotosHTML = '';
                if (i.fotos && i.fotos.length > 0) {
                    fotosHTML = `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-images"></i> FOTOS (${i.fotos.length})</div>
                            <div class="photos-preview-container">
                                ${i.fotos.map((foto, index) => `
                                    <img src="${foto}" class="photo-preview" onclick="UI.openPhotoFullscreen('${id}', ${index})">
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Campos específicos
                let camposEspecificos = '';
                if (i.tipo === 'lote') {
                    camposEspecificos = `
                        <div class="details-info-grid">
                            <div class="info-item">
                                <div class="info-label">Largura</div>
                                <div class="info-value">${i.largura || '-'} m</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Comprimento</div>
                                <div class="info-value">${i.comprimento || '-'} m</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Área Total</div>
                                <div class="info-value">${i.area || '-'} m²</div>
                            </div>
                        </div>
                    `;
                } else {
                    camposEspecificos = `
                        <div class="details-info-grid">
                            ${i.quartos ? `
                            <div class="info-item">
                                <div class="info-label">Quartos</div>
                                <div class="info-value">${i.quartos}</div>
                            </div>
                            ` : ''}
                            ${i.banheiros ? `
                            <div class="info-item">
                                <div class="info-label">Banheiros</div>
                                <div class="info-value">${i.banheiros}</div>
                            </div>
                            ` : ''}
                            ${i.vagas ? `
                            <div class="info-item">
                                <div class="info-label">Vagas</div>
                                <div class="info-value">${i.vagas}</div>
                            </div>
                            ` : ''}
                            ${i.area ? `
                            <div class="info-item">
                                <div class="info-label">Área</div>
                                <div class="info-value">${i.area} m²</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div>
                                <div class="details-title">${i.nome}</div>
                                <div class="details-subtitle">${i.tipo ? i.tipo.charAt(0).toUpperCase() + i.tipo.slice(1) : 'Imóvel'}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${modalidadeBadge}
                                ${statusBadge}
                            </div>
                        </div>
                        
                        ${fotosHTML}
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-info-circle"></i> INFORMAÇÕES GERAIS</div>
                            ${camposEspecificos}
                            <div class="details-info-grid" style="margin-top: 12px;">
                                <div class="info-item">
                                    <div class="info-label">Valor</div>
                                    <div class="info-value" style="color: var(--primary); font-size: 1.2rem;">${Utils.formatCurrency(i.valor)}</div>
                                </div>
                                ${i.construtora ? `
                                <div class="info-item">
                                    <div class="info-label">Construtora</div>
                                    <div class="info-value">${i.construtora}</div>
                                </div>
                                ` : ''}
                                ${i.dataEntrega ? `
                                <div class="info-item">
                                    <div class="info-label">Data de Entrega</div>
                                    <div class="info-value">${Utils.formatDate(i.dataEntrega)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-map-marker-alt"></i> LOCALIZAÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Endereço/Localização</div>
                                <div class="info-value">${i.localizacao || 'Não informada'}</div>
                            </div>
                        </div>
                        
                        ${i.formaPagamento ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-money-check-alt"></i> FORMA DE PAGAMENTO</div>
                            <div class="info-item">
                                <div class="info-label">Condições</div>
                                <div class="info-value">${i.formaPagamento}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${i.descricao ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-align-left"></i> DESCRIÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Detalhes</div>
                                <div class="info-value">${i.descricao}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${clientesInteressados.length > 0 ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-users"></i> CLIENTES INTERESSADOS (${clientesInteressados.length})</div>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${clientesInteressados.slice(0, 5).map(c => `
                                    <div class="list-card" style="margin-bottom: 8px;" onclick="UI.showClienteDetails('${c.id}')">
                                        <div class="card-header">
                                            <div class="card-title">${c.nome}</div>
                                            <span class="tag ${c.status === 'lead' ? 'tag-lead' : (c.status === 'closed' ? 'tag-closed' : 'tag-prospect')}">
                                                ${Utils.getStatusText(c.status)}
                                            </span>
                                        </div>
                                        <div class="card-subtitle">${c.telefone} ${c.renda ? '• ' + Utils.formatCurrency(c.renda) : ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.imovel.gerarFichaPDF('${i.id}')">
                                <i class="fas fa-file-pdf"></i> Ficha PDF
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.shareImovel('${i.id}')">
                                <i class="fab fa-whatsapp"></i> Compartilhar
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="App.imovel.edit('${i.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('imovel-details-content').innerHTML = detailsContent;
                UI.openModal('imovel-details');
            },
            
            showAgendaDetails: (id) => {
                const a = UI.data.agenda.find(x => x.id === id);
                if (!a) return;
                
                const c = UI.data.clientes.find(cl => cl.id === a.clienteId) || { nome: 'Desconhecido' };
                const i = a.imovelId ? UI.data.imoveis.find(im => im.id === a.imovelId) : null;
                
                let statusBadge = '';
                if (a.status === 'cancelado') statusBadge = `<span class="badge badge-danger">CANCELADO</span>`;
                else if (a.status === 'realizado') statusBadge = `<span class="badge badge-success">REALIZADO</span>`;
                else if (a.status === 'confirmado') statusBadge = `<span class="badge badge-primary">CONFIRMADO</span>`;
                else statusBadge = `<span class="badge badge-warning">AGENDADO</span>`;
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div>
                                <div class="details-title">${a.tipo === 'visita' ? 'Visita Agendada' : 'Reunião'}</div>
                                <div class="details-subtitle">Com ${c.nome}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-calendar-alt"></i> DETALHES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Data</div>
                                    <div class="info-value">${Utils.formatDate(a.data)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Horário</div>
                                    <div class="info-value">${a.horario}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Local</div>
                                    <div class="info-value">${a.local || 'Não informado'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Cliente</div>
                                    <div class="info-value">${c.nome}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${i ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-home"></i> IMÓVEL</div>
                            <div class="list-card" onclick="UI.showImovelDetails('${i.id}')">
                                <div class="card-header">
                                    <div class="card-title">${i.nome}</div>
                                    <span class="tag ${i.modalidade === 'lote' ? 'tag-lote' : (i.modalidade === 'pronto' ? 'tag-pronto' : 'tag-pre-lancamento')}">
                                        ${Utils.getModalidadeText(i.modalidade)}
                                    </span>
                                </div>
                                <div class="card-subtitle">${Utils.formatCurrency(i.valor)} • ${i.localizacao ? i.localizacao.substring(0, 30) + '...' : ''}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${a.descricao ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-sticky-note"></i> DESCRIÇÃO/OBSERVAÇÕES</div>
                            <div class="info-item">
                                <div class="info-label">Detalhes</div>
                                <div class="info-value">${a.descricao}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.agenda.edit('${a.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-danger" onclick="App.agenda.delete('${a.id}')">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                // Criar modal temporário
                const tempModal = document.createElement('div');
                tempModal.className = 'modal-overlay active';
                tempModal.innerHTML = `
                    <div class="modal-sheet" style="transform: translateY(0);">
                        <div class="sheet-handle"></div>
                        <div id="agenda-details-content">${detailsContent}</div>
                    </div>
                `;
                
                tempModal.addEventListener('click', (e) => {
                    if (e.target === tempModal) {
                        document.body.removeChild(tempModal);
                    }
                });
                
                document.body.appendChild(tempModal);
            },
            
            // --- UTILITIES ---
            updateFilterButtons: (viewId, activeFilter) => {
                const buttons = document.querySelectorAll(`#${viewId} .filter-buttons .filter-btn`);
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === activeFilter || 
                        (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${activeFilter}'`))) {
                        btn.classList.add('active');
                    }
                });
            },
            
            toggleTheme: () => {
                const isDark = document.body.classList.toggle('dark-mode');
                const settings = Storage.getSettings();
                settings.tema = isDark ? 'dark' : 'light';
                Storage.saveSettings(settings);
                
                const icon = document.querySelector('.theme-toggle i');
                icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            },
            
            checkAniversarios: () => {
                const settings = Storage.getSettings();
                const diasNotificar = parseInt(settings.notificarAniversarios || 0);
                
                if (diasNotificar === 0) return;
                
                const hoje = new Date();
                const dataFutura = new Date();
                dataFutura.setDate(hoje.getDate() + diasNotificar);
                
                const aniversariantesProximos = UI.data.clientes.filter(c => {
                    if (!c.nascimento) return false;
                    
                    const [ano, mes, dia] = c.nascimento.split('-');
                    const dataAniversario = new Date(hoje.getFullYear(), parseInt(mes) - 1, parseInt(dia));
                    
                    // Verificar se o aniversário está dentro do período de notificação
                    const diffTime = dataAniversario - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    return diffDays >= 0 && diffDays <= diasNotificar;
                });
                
                if (aniversariantesProximos.length > 0) {
                    const nomes = aniversariantesProximos.map(c => c.nome.split(' ')[0]).join(', ');
                    setTimeout(() => {
                        Utils.toast(`🎂 Aniversário${aniversariantesProximos.length > 1 ? 's' : ''} em ${diasNotificar} dia${diasNotificar > 1 ? 's' : ''}: ${nomes}`, 'warning', 5000);
                    }, 1000);
                }
            }
        };

        // --- APP LOGIC ---
        const App = {
            cliente: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('c-id').value || Utils.id();
                    const nome = document.getElementById('c-nome').value;
                    const telefone = document.getElementById('c-telefone').value;
                    const email = document.getElementById('c-email').value;
                    const nascimento = document.getElementById('c-nascimento').value;
                    const cpf = document.getElementById('c-cpf').value;
                    const renda = Utils.parseCurrency(document.getElementById('c-renda').value);
                    const status = document.getElementById('c-status').value;
                    const observacoes = document.getElementById('c-observacoes').value;
                    
                    // Obter imóveis de interesse (checkboxes)
                    const imoveisCheckboxes = document.querySelectorAll('#c-imoveis-interesse-list input[type="checkbox"]:checked');
                    const imoveisInteresse = Array.from(imoveisCheckboxes).map(cb => cb.value);
                    
                    const newClient = { 
                        id, 
                        nome, 
                        telefone, 
                        email,
                        nascimento,
                        cpf,
                        renda,
                        status,
                        observacoes,
                        imoveisInteresse,
                        dataCadastro: new Date().toISOString().split('T')[0],
                        ultimoContato: new Date().toISOString().split('T')[0]
                    };
                    
                    // Se for fechado, adicionar data de fechamento
                    if (status === 'closed' && !UI.data.clientes.find(c => c.id === id)?.dataFechamento) {
                        newClient.dataFechamento = new Date().toISOString().split('T')[0];
                    }
                    
                    const existingIdx = UI.data.clientes.findIndex(c => c.id === id);
                    if (existingIdx >= 0) {
                        UI.data.clientes[existingIdx] = newClient;
                    } else {
                        UI.data.clientes.push(newClient);
                    }
                    
                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Cliente salvo com sucesso!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderClientes();
                    UI.renderFunil();
                },
                
                edit: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if (!c) return;
                    
                    document.getElementById('c-id').value = c.id;
                    document.getElementById('c-nome').value = c.nome;
                    document.getElementById('c-telefone').value = c.telefone;
                    document.getElementById('c-email').value = c.email || '';
                    document.getElementById('c-nascimento').value = c.nascimento || '';
                    document.getElementById('c-cpf').value = c.cpf || '';
                    
                    const rendaInput = document.getElementById('c-renda');
                    if (c.renda) {
                        rendaInput.value = (c.renda * 100).toFixed(0);
                        Utils.maskMoney(rendaInput);
                    } else {
                        rendaInput.value = '';
                    }
                    
                    document.getElementById('c-status').value = c.status;
                    document.getElementById('c-observacoes').value = c.observacoes || '';
                    
                    // Carregar imóveis de interesse
                    const imoveisList = document.getElementById('c-imoveis-interesse-list');
                    imoveisList.innerHTML = '';
                    
                    UI.data.imoveis.forEach(i => {
                        if (i.status !== 'vendido') {
                            const checked = c.imoveisInteresse && c.imoveisInteresse.includes(i.id) ? 'checked' : '';
                            imoveisList.innerHTML += `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border);">
                                    <input type="checkbox" id="imovel-${i.id}" value="${i.id}" ${checked} style="width: 18px; height: 18px;">
                                    <label for="imovel-${i.id}" style="flex: 1; cursor: pointer;">
                                        <div style="font-weight: 600; font-size: 0.9rem;">${i.nome}</div>
                                        <div style="font-size: 0.8rem; color: var(--secondary);">${Utils.formatCurrency(i.valor)}</div>
                                    </label>
                                </div>
                            `;
                        }
                    });
                    
                    document.getElementById('title-cliente').innerText = 'Editar Cliente';
                    UI.openModal('cliente');
                },
                
                delete: (id) => {
                    if (confirm('Tem certeza que deseja excluir este cliente?')) {
                        UI.data.clientes = UI.data.clientes.filter(c => c.id !== id);
                        Storage.set('clientes', UI.data.clientes);
                        UI.renderDashboard();
                        UI.renderClientes();
                        UI.renderFunil();
                        Utils.toast('Cliente excluído com sucesso!', 'success');
                    }
                },
                
                gerarFichaPDF: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if (!c) return;
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('FICHA DE CLIENTE', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    
                    // Dados do cliente
                    let y = 60;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Nome: ${c.nome}`, 20, y);
                    y += 10;
                    doc.text(`Telefone: ${c.telefone}`, 20, y);
                    y += 10;
                    
                    if (c.email) {
                        doc.text(`Email: ${c.email}`, 20, y);
                        y += 10;
                    }
                    
                    if (c.cpf) {
                        doc.text(`CPF: ${c.cpf}`, 20, y);
                        y += 10;
                    }
                    
                    if (c.nascimento) {
                        const idade = Utils.calcularIdade(c.nascimento);
                        doc.text(`Data Nascimento: ${Utils.formatDate(c.nascimento)} ${idade ? `(${idade} anos)` : ''}`, 20, y);
                        y += 10;
                    }
                    
                    if (c.renda) {
                        doc.text(`Renda Mensal: ${Utils.formatCurrency(c.renda)}`, 20, y);
                        y += 10;
                    }
                    
                    doc.text(`Status: ${Utils.getStatusText(c.status)}`, 20, y);
                    y += 10;
                    
                    doc.text(`Data Cadastro: ${Utils.formatDate(c.dataCadastro)}`, 20, y);
                    y += 15;
                    
                    // Imóveis de interesse
                    if (c.imoveisInteresse && c.imoveisInteresse.length > 0) {
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('IMÓVEIS DE INTERESSE:', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        c.imoveisInteresse.forEach((imovelId, index) => {
                            const i = UI.data.imoveis.find(im => im.id === imovelId);
                            if (i && y < 250) {
                                doc.text(`${index + 1}. ${i.nome}`, 25, y);
                                y += 7;
                                doc.text(`   Valor: ${Utils.formatCurrency(i.valor)}`, 25, y);
                                y += 7;
                                doc.text(`   Localização: ${i.localizacao || 'Não informada'}`, 25, y);
                                y += 10;
                            }
                        });
                    }
                    
                    // Observações
                    if (c.observacoes) {
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('OBSERVAÇÕES:', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        const observacoesLines = doc.splitTextToSize(c.observacoes, 170);
                        observacoesLines.forEach(line => {
                            doc.text(line, 25, y);
                            y += 7;
                        });
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Ficha_Cliente_${c.nome.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Ficha do cliente gerada em PDF!');
                }
            },
            
            imovel: {
                fotos: [],
                
                toggleTipoFields: () => {
                    const tipo = document.getElementById('i-tipo').value;
                    
                    // Ocultar todos os campos dinâmicos
                    document.querySelectorAll('.dynamic-fields').forEach(field => {
                        field.classList.add('hidden');
                    });
                    
                    // Mostrar campos apropriados
                    if (tipo === 'lote') {
                        document.getElementById('campos-lote').classList.remove('hidden');
                    } else {
                        document.getElementById('campos-apartamento').classList.remove('hidden');
                    }
                },
                
                handleFotos: async (input) => {
                    if (input.files && input.files.length > 0) {
                        const files = Array.from(input.files);
                        const maxFotos = 20;
                        const fotosAtuais = App.imovel.fotos.length;
                        
                        if (fotosAtuais + files.length > maxFotos) {
                            Utils.toast(`Máximo de ${maxFotos} fotos permitido`, 'error');
                            return;
                        }
                        
                        try {
                            for (const file of files.slice(0, maxFotos - fotosAtuais)) {
                                const base64 = await Utils.readImage(file);
                                App.imovel.fotos.push(base64);
                            }
                            
                            App.imovel.renderFotos();
                            Utils.toast(`${files.length} foto(s) adicionada(s)`, 'success');
                        } catch (e) {
                            Utils.toast('Erro ao processar fotos', 'error');
                        }
                    }
                },
                
                renderFotos: () => {
                    const container = document.getElementById('fotos-container');
                    container.innerHTML = App.imovel.fotos.map((foto, index) => `
                        <img src="${foto}" class="photo-preview" onclick="App.imovel.removeFoto(${index})">
                    `).join('');
                    
                    // Adicionar botão de upload se ainda houver espaço
                    if (App.imovel.fotos.length < 20) {
                        container.innerHTML += `
                            <div class="photo-upload-area" onclick="document.getElementById('i-fotos-input').click()">
                                <i class="fas fa-plus"></i>
                            </div>
                        `;
                    }
                    
                    // Salvar fotos em campo hidden
                    document.getElementById('i-fotos-data').value = JSON.stringify(App.imovel.fotos);
                },
                
                removeFoto: (index) => {
                    App.imovel.fotos.splice(index, 1);
                    App.imovel.renderFotos();
                    Utils.toast('Foto removida');
                },
                
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('i-id').value || Utils.id();
                    const tipo = document.getElementById('i-tipo').value;
                    const nome = document.getElementById('i-nome').value;
                    const modalidade = document.getElementById('i-modalidade').value;
                    const construtora = document.getElementById('i-construtora').value;
                    const valor = Utils.parseCurrency(document.getElementById('i-valor').value);
                    const formaPagamento = document.getElementById('i-forma-pagamento').value;
                    const dataEntrega = document.getElementById('i-data-entrega').value;
                    const localizacao = document.getElementById('i-localizacao').value;
                    const descricao = document.getElementById('i-descricao').value;
                    const status = document.getElementById('i-status').value;
                    
                    // Campos específicos
                    let quartos, banheiros, vagas, area, largura, comprimento, areaLote;
                    
                    if (tipo === 'lote') {
                        largura = parseFloat(document.getElementById('i-largura').value?.replace(',', '.')) || 0;
                        comprimento = parseFloat(document.getElementById('i-comprimento').value?.replace(',', '.')) || 0;
                        areaLote = parseFloat(document.getElementById('i-area-lote').value?.replace(',', '.')) || 0;
                        area = areaLote;
                    } else {
                        quartos = parseInt(document.getElementById('i-quartos').value) || 0;
                        banheiros = parseInt(document.getElementById('i-banheiros').value) || 0;
                        vagas = parseInt(document.getElementById('i-vagas').value) || 0;
                        area = parseFloat(document.getElementById('i-area').value?.replace(',', '.')) || 0;
                    }
                    
                    // Obter fotos
                    let fotos = [];
                    try {
                        fotos = JSON.parse(document.getElementById('i-fotos-data').value) || App.imovel.fotos;
                    } catch (e) {
                        fotos = App.imovel.fotos;
                    }
                    
                    const imovel = {
                        id,
                        tipo,
                        nome,
                        modalidade,
                        construtora,
                        valor,
                        formaPagamento,
                        dataEntrega,
                        localizacao,
                        descricao,
                        status,
                        quartos,
                        banheiros,
                        vagas,
                        area,
                        largura,
                        comprimento,
                        fotos,
                        dataCadastro: new Date().toISOString().split('T')[0]
                    };
                    
                    // Se foi vendido, registrar data
                    if (status === 'vendido' && !UI.data.imoveis.find(i => i.id === id)?.dataVenda) {
                        imovel.dataVenda = new Date().toISOString().split('T')[0];
                    }
                    
                    const idx = UI.data.imoveis.findIndex(i => i.id === id);
                    if (idx >= 0) {
                        UI.data.imoveis[idx] = imovel;
                    } else {
                        UI.data.imoveis.push(imovel);
                    }
                    
                    Storage.set('imoveis', UI.data.imoveis);
                    Utils.toast('Imóvel salvo com sucesso!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderImoveis();
                    
                    // Resetar fotos
                    App.imovel.fotos = [];
                },
                
                edit: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    if (!i) return;
                    
                    document.getElementById('i-id').value = i.id;
                    document.getElementById('i-tipo').value = i.tipo || 'apartamento';
                    document.getElementById('i-nome').value = i.nome;
                    document.getElementById('i-modalidade').value = i.modalidade || 'pre-lancamento';
                    document.getElementById('i-construtora').value = i.construtora || '';
                    document.getElementById('i-forma-pagamento').value = i.formaPagamento || '';
                    document.getElementById('i-data-entrega').value = i.dataEntrega || '';
                    document.getElementById('i-localizacao').value = i.localizacao || '';
                    document.getElementById('i-descricao').value = i.descricao || '';
                    document.getElementById('i-status').value = i.status || 'disponivel';
                    
                    const valorInput = document.getElementById('i-valor');
                    if (i.valor) {
                        valorInput.value = (i.valor * 100).toFixed(0);
                        Utils.maskMoney(valorInput);
                    } else {
                        valorInput.value = '';
                    }
                    
                    // Preencher campos específicos
                    if (i.tipo === 'lote') {
                        document.getElementById('i-largura').value = i.largura || '';
                        document.getElementById('i-comprimento').value = i.comprimento || '';
                        document.getElementById('i-area-lote').value = i.area || '';
                    } else {
                        document.getElementById('i-quartos').value = i.quartos || '';
                        document.getElementById('i-banheiros').value = i.banheiros || '';
                        document.getElementById('i-vagas').value = i.vagas || '';
                        document.getElementById('i-area').value = i.area || '';
                    }
                    
                    // Carregar fotos
                    App.imovel.fotos = i.fotos || [];
                    App.imovel.renderFotos();
                    
                    // Mostrar campos apropriados
                    App.imovel.toggleTipoFields();
                    
                    document.getElementById('title-imovel').innerText = 'Editar Imóvel';
                    UI.openModal('imovel');
                },
                
                delete: (id) => {
                    if (confirm('Tem certeza que deseja excluir este imóvel?')) {
                        UI.data.imoveis = UI.data.imoveis.filter(i => i.id !== id);
                        Storage.set('imoveis', UI.data.imoveis);
                        UI.renderDashboard();
                        UI.renderImoveis();
                        Utils.toast('Imóvel excluído com sucesso!', 'success');
                    }
                },
                
                gerarFichaPDF: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    if (!i) return;
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('FICHA DE IMÓVEL', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    
                    // Dados do imóvel
                    let y = 60;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Nome: ${i.nome}`, 20, y);
                    y += 10;
                    doc.text(`Tipo: ${i.tipo.charAt(0).toUpperCase() + i.tipo.slice(1)}`, 20, y);
                    y += 10;
                    doc.text(`Modalidade: ${Utils.getModalidadeText(i.modalidade)}`, 20, y);
                    y += 10;
                    doc.text(`Valor: ${Utils.formatCurrency(i.valor)}`, 20, y);
                    y += 10;
                    
                    if (i.construtora) {
                        doc.text(`Construtora: ${i.construtora}`, 20, y);
                        y += 10;
                    }
                    
                    if (i.dataEntrega) {
                        doc.text(`Data de Entrega: ${Utils.formatDate(i.dataEntrega)}`, 20, y);
                        y += 10;
                    }
                    
                    if (i.localizacao) {
                        doc.text(`Localização: ${i.localizacao}`, 20, y);
                        y += 10;
                    }
                    
                    // Características
                    if (i.tipo === 'lote') {
                        if (i.area) {
                            doc.text(`Área: ${i.area} m²`, 20, y);
                            y += 10;
                        }
                        if (i.largura && i.comprimento) {
                            doc.text(`Dimensões: ${i.largura}m x ${i.comprimento}m`, 20, y);
                            y += 10;
                        }
                    } else {
                        if (i.quartos) {
                            doc.text(`Quartos: ${i.quartos}`, 20, y);
                            y += 10;
                        }
                        if (i.banheiros) {
                            doc.text(`Banheiros: ${i.banheiros}`, 20, y);
                            y += 10;
                        }
                        if (i.vagas) {
                            doc.text(`Vagas: ${i.vagas}`, 20, y);
                            y += 10;
                        }
                        if (i.area) {
                            doc.text(`Área: ${i.area} m²`, 20, y);
                            y += 10;
                        }
                    }
                    
                    // Forma de pagamento
                    if (i.formaPagamento) {
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('FORMA DE PAGAMENTO:', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        const pagamentoLines = doc.splitTextToSize(i.formaPagamento, 170);
                        pagamentoLines.forEach(line => {
                            doc.text(line, 25, y);
                            y += 7;
                        });
                        y += 5;
                    }
                    
                    // Descrição
                    if (i.descricao) {
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('DESCRIÇÃO:', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        const descricaoLines = doc.splitTextToSize(i.descricao, 170);
                        descricaoLines.forEach(line => {
                            doc.text(line, 25, y);
                            y += 7;
                        });
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Ficha_Imovel_${i.nome.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Ficha do imóvel gerada em PDF!');
                }
            },
            
            agenda: {
                saveVisita: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('av-id').value || Utils.id();
                    const clienteId = document.getElementById('av-cliente').value;
                    const imovelId = document.getElementById('av-imovel').value;
                    const data = document.getElementById('av-data').value;
                    const horario = document.getElementById('av-horario').value;
                    const local = document.getElementById('av-local').value;
                    const tipoVisita = document.getElementById('av-tipo-visita').value;
                    const observacoes = document.getElementById('av-observacoes').value;
                    
                    const agendamento = {
                        id,
                        tipo: 'visita',
                        clienteId,
                        imovelId,
                        data,
                        horario,
                        local: local || '',
                        descricao: `Visita ${tipoVisita}: ${observacoes || ''}`,
                        status: 'agendado',
                        dataCriacao: new Date().toISOString()
                    };
                    
                    // Atualizar último contato do cliente
                    const clienteIdx = UI.data.clientes.findIndex(c => c.id === clienteId);
                    if (clienteIdx >= 0) {
                        UI.data.clientes[clienteIdx].ultimoContato = data;
                    }
                    
                    const idx = UI.data.agenda.findIndex(a => a.id === id);
                    if (idx >= 0) {
                        UI.data.agenda[idx] = agendamento;
                    } else {
                        UI.data.agenda.push(agendamento);
                    }
                    
                    Storage.set('agenda', UI.data.agenda);
                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Visita agendada com sucesso!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderAgenda();
                },
                
                saveReuniao: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('ar-id').value || Utils.id();
                    const clienteId = document.getElementById('ar-cliente').value;
                    const assunto = document.getElementById('ar-assunto').value;
                    const data = document.getElementById('ar-data').value;
                    const horario = document.getElementById('ar-horario').value;
                    const local = document.getElementById('ar-local').value;
                    const tipo = document.getElementById('ar-tipo').value;
                    const participantes = document.getElementById('ar-participantes').value;
                    const pauta = document.getElementById('ar-pauta').value;
                    
                    const agendamento = {
                        id,
                        tipo: 'reuniao',
                        clienteId,
                        data,
                        horario,
                        local,
                        descricao: `Reunião ${tipo}: ${assunto}\nParticipantes: ${participantes || ''}\nPauta: ${pauta || ''}`,
                        status: 'agendado',
                        dataCriacao: new Date().toISOString()
                    };
                    
                    // Atualizar último contato do cliente
                    const clienteIdx = UI.data.clientes.findIndex(c => c.id === clienteId);
                    if (clienteIdx >= 0) {
                        UI.data.clientes[clienteIdx].ultimoContato = data;
                    }
                    
                    const idx = UI.data.agenda.findIndex(a => a.id === id);
                    if (idx >= 0) {
                        UI.data.agenda[idx] = agendamento;
                    } else {
                        UI.data.agenda.push(agendamento);
                    }
                    
                    Storage.set('agenda', UI.data.agenda);
                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Reunião agendada com sucesso!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderAgenda();
                },
                
                edit: (id) => {
                    const a = UI.data.agenda.find(x => x.id === id);
                    if (!a) return;
                    
                    if (a.tipo === 'visita') {
                        // Carregar dados da visita
                        const selectCliente = document.getElementById('av-cliente');
                        const selectImovel = document.getElementById('av-imovel');
                        
                        // Carregar clientes
                        selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                        UI.data.clientes.forEach(c => {
                            const selected = c.id === a.clienteId ? 'selected' : '';
                            selectCliente.innerHTML += `<option value="${c.id}" ${selected}>${c.nome} - ${c.telefone}</option>`;
                        });
                        
                        // Carregar imóveis
                        selectImovel.innerHTML = '<option value="">Selecione um imóvel...</option>';
                        UI.data.imoveis.forEach(i => {
                            const selected = i.id === a.imovelId ? 'selected' : '';
                            selectImovel.innerHTML += `<option value="${i.id}" ${selected}>${i.nome} - ${Utils.formatCurrency(i.valor)}</option>`;
                        });
                        
                        document.getElementById('av-id').value = a.id;
                        document.getElementById('av-data').value = a.data;
                        document.getElementById('av-horario').value = a.horario;
                        document.getElementById('av-local').value = a.local || '';
                        document.getElementById('av-observacoes').value = a.descricao || '';
                        
                        UI.openModal('agenda-visita');
                    } else if (a.tipo === 'reuniao') {
                        // Carregar dados da reunião
                        const selectCliente = document.getElementById('ar-cliente');
                        
                        selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                        UI.data.clientes.forEach(c => {
                            const selected = c.id === a.clienteId ? 'selected' : '';
                            selectCliente.innerHTML += `<option value="${c.id}" ${selected}>${c.nome} - ${c.telefone}</option>`;
                        });
                        
                        document.getElementById('ar-id').value = a.id;
                        document.getElementById('ar-data').value = a.data;
                        document.getElementById('ar-horario').value = a.horario;
                        document.getElementById('ar-local').value = a.local || '';
                        document.getElementById('ar-assunto').value = a.descricao?.split(':')[1]?.trim() || '';
                        
                        UI.openModal('agenda-reuniao');
                    }
                },
                
                delete: (id) => {
                    if (confirm('Tem certeza que deseja excluir este agendamento?')) {
                        UI.data.agenda = UI.data.agenda.filter(a => a.id !== id);
                        Storage.set('agenda', UI.data.agenda);
                        UI.renderDashboard();
                        UI.renderAgenda();
                        Utils.toast('Agendamento excluído com sucesso!', 'success');
                    }
                }
            },
            
            funil: {
                saveEtapa: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('etapa-id').value || Utils.id();
                    const nome = document.getElementById('etapa-nome').value;
                    const cor = document.getElementById('etapa-cor').value;
                    const ordem = parseInt(document.getElementById('etapa-ordem').value);
                    const descricao = document.getElementById('etapa-descricao').value;
                    
                    const etapa = { id, nome, cor, ordem, descricao };
                    
                    const idx = UI.data.funilEtapas.findIndex(e => e.id === id);
                    if (idx >= 0) {
                        UI.data.funilEtapas[idx] = etapa;
                    } else {
                        UI.data.funilEtapas.push(etapa);
                    }
                    
                    // Ordenar por ordem
                    UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem);
                    
                    Storage.saveFunilEtapas(UI.data.funilEtapas);
                    Utils.toast('Etapa do funil salva com sucesso!');
                    UI.closeModals();
                    UI.renderFunil();
                },
                
                deleteEtapa: (id) => {
                    if (confirm('Tem certeza que deseja excluir esta etapa? Os clientes nesta etapa serão movidos para a etapa anterior.')) {
                        // Encontrar índice da etapa
                        const etapaIndex = UI.data.funilEtapas.findIndex(e => e.id === id);
                        if (etapaIndex === -1) return;
                        
                        // Encontrar etapa anterior
                        const etapaAnterior = etapaIndex > 0 ? UI.data.funilEtapas[etapaIndex - 1] : null;
                        
                        // Mover clientes para etapa anterior ou remover status
                        if (etapaAnterior) {
                            UI.data.clientes.forEach(c => {
                                if (c.status === id) {
                                    c.status = etapaAnterior.id;
                                }
                            });
                            Storage.set('clientes', UI.data.clientes);
                        } else {
                            // Se for a primeira etapa, remover status dos clientes
                            UI.data.clientes.forEach(c => {
                                if (c.status === id) {
                                    c.status = '';
                                }
                            });
                            Storage.set('clientes', UI.data.clientes);
                        }
                        
                        // Remover etapa
                        UI.data.funilEtapas = UI.data.funilEtapas.filter(e => e.id !== id);
                        Storage.saveFunilEtapas(UI.data.funilEtapas);
                        
                        Utils.toast('Etapa excluída com sucesso!', 'success');
                        UI.renderDashboard();
                        UI.renderClientes();
                        UI.renderFunil();
                    }
                }
            },
            
            metas: {
                salvarConfig: () => {
                    const metaLeads = parseInt(document.getElementById('config-meta-leads').value) || 0;
                    const convLeadsVisitas = parseInt(document.getElementById('config-conv-leads-visitas').value) || 0;
                    const convVisitasDocs = parseInt(document.getElementById('config-conv-visitas-docs').value) || 0;
                    const convDocsAprovacoes = parseInt(document.getElementById('config-conv-docs-aprovacoes').value) || 0;
                    const convAprovacoesVendas = parseInt(document.getElementById('config-conv-aprovacoes-vendas').value) || 0;
                    
                    const metas = {
                        metaLeads,
                        convLeadsVisitas,
                        convVisitasDocs,
                        convDocsAprovacoes,
                        convAprovacoesVendas,
                        dataConfig: new Date().toISOString().split('T')[0]
                    };
                    
                    UI.data.metas = metas;
                    Storage.saveMetas(metas);
                    
                    Utils.toast('Configuração de metas salva com sucesso!');
                    UI.renderDashboard();
                    UI.renderMetas();
                },
                
                calcularProgressoTotal: () => {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth() + 1;
                    const anoAtual = hoje.getFullYear();
                    
                    // Calcular valores atuais
                    const clientesMes = UI.data.clientes.filter(c => 
                        c.dataCadastro && 
                        c.dataCadastro.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    const vendasMes = UI.data.clientes.filter(c => 
                        c.status === 'closed' && 
                        c.dataFechamento &&
                        c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    const receitaMes = UI.data.clientes
                        .filter(c => c.status === 'closed' && c.valorVenda && c.dataFechamento && c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`))
                        .reduce((acc, c) => acc + (c.valorVenda || 0), 0);
                    
                    const visitasMes = UI.data.agenda.filter(a => 
                        a.tipo === 'visita' && 
                        a.data &&
                        a.data.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    // Calcular metas esperadas (usando configuração padrão se não houver)
                    const metas = UI.data.metas;
                    const metaLeads = metas.metaLeads || 100;
                    const metaReceita = 0; // Não temos meta de receita configurável ainda
                    const metaNovosClientes = metaLeads * 0.2; // 20% dos leads viram clientes
                    const metaVisitas = metaLeads * (metas.convLeadsVisitas / 100) || 40;
                    
                    // Calcular progressos individuais
                    const progressoVendas = metaLeads > 0 ? Math.min((vendasMes / metaLeads) * 100, 100) : 0;
                    const progressoReceita = metaReceita > 0 ? Math.min((receitaMes / metaReceita) * 100, 100) : 0;
                    const progressoClientes = metaNovosClientes > 0 ? Math.min((clientesMes / metaNovosClientes) * 100, 100) : 0;
                    const progressoVisitas = metaVisitas > 0 ? Math.min((visitasMes / metaVisitas) * 100, 100) : 0;
                    
                    // Média ponderada (vendas tem peso maior)
                    const progressoTotal = (progressoVendas * 0.4 + progressoReceita * 0.3 + progressoClientes * 0.2 + progressoVisitas * 0.1);
                    
                    return Math.min(progressoTotal, 100);
                },
                
                calcularTendencia: () => {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth() + 1;
                    const anoAtual = hoje.getFullYear();
                    const diasPassados = hoje.getDate();
                    const totalDiasMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
                    
                    const vendasMes = UI.data.clientes.filter(c => 
                        c.status === 'closed' && 
                        c.dataFechamento &&
                        c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    // Calcular tendência (projeção para o mês inteiro)
                    const tendencia = diasPassados > 0 ? (vendasMes / diasPassados) * totalDiasMes : 0;
                    
                    return Math.round(tendencia);
                }
            },
            
            settings: {
                previewLogo: async (input) => {
                    if (input.files && input.files[0]) {
                        try {
                            const base64 = await Utils.readImage(input.files[0]);
                            document.getElementById('s-logo-data').value = base64;
                            document.getElementById('s-logo-preview').src = base64;
                            document.getElementById('s-logo-preview').style.display = 'block';
                            document.getElementById('s-logo-placeholder').style.display = 'none';
                        } catch (e) {
                            Utils.toast('Erro ao carregar imagem', 'error');
                        }
                    }
                },
                
                save: (e) => {
                    e.preventDefault();
                    const s = Storage.getSettings();
                    
                    s.nome = document.getElementById('s-nome').value;
                    s.creci = document.getElementById('s-creci').value;
                    s.telefone = document.getElementById('s-telefone').value;
                    s.email = document.getElementById('s-email').value;
                    s.instagram = document.getElementById('s-instagram').value;
                    s.endereco = document.getElementById('s-endereco').value;
                    s.logo = document.getElementById('s-logo-data').value;
                    s.notificarAniversarios = document.getElementById('s-notificar-aniversarios').value;
                    
                    Storage.saveSettings(s);
                    Utils.toast('Configurações salvas com sucesso!');
                    UI.closeModals();
                }
            },
            
            whatsapp: {
                confirmOpenCliente: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if (!c) return;
                    
                    const num = Utils.formatPhoneForWhatsApp(c.telefone);
                    const settings = Storage.getSettings();
                    const saudacao = Utils.getSaudacao();
                    
                    let msg = `${saudacao}, ${c.nome.split(' ')[0]}! Tudo bem?\n\n`;
                    msg += `Aqui é ${settings.nome.split(' ')[0]} da ${settings.nome}.\n`;
                    msg += `Como posso te ajudar hoje?`;
                    
                    window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
                },
                
                enviarParabens: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if (!c) return;
                    
                    const num = Utils.formatPhoneForWhatsApp(c.telefone);
                    const settings = Storage.getSettings();
                    const idade = Utils.calcularIdade(c.nascimento);
                    
                    let msg = `🎉 *Parabéns, ${c.nome.split(' ')[0]}!*\n\n`;
                    msg += `Que este ${idade ? `${idade}º ` : ''}aniversário seja repleto de alegrias, saúde e muitas conquistas!\n\n`;
                    msg += `Desejo um dia maravilhoso e um ano abençoado!\n\n`;
                    msg += `Um abraço,\n`;
                    msg += `${settings.nome.split(' ')[0]}\n`;
                    msg += `${settings.nome}`;
                    
                    window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
                },
                
                shareImovel: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    const settings = Storage.getSettings();
                    
                    if (!i) return;
                    
                    let msg = `🏠 *${i.nome}*\n\n`;
                    msg += `💰 *Valor:* ${Utils.formatCurrency(i.valor)}\n`;
                    
                    if (i.tipo === 'lote') {
                        msg += `📏 *Área:* ${i.area || '-'} m²\n`;
                        if (i.largura && i.comprimento) {
                            msg += `📐 *Dimensões:* ${i.largura}m x ${i.comprimento}m\n`;
                        }
                    } else {
                        if (i.quartos) msg += `🛏️ *Quartos:* ${i.quartos}\n`;
                        if (i.banheiros) msg += `🚿 *Banheiros:* ${i.banheiros}\n`;
                        if (i.vagas) msg += `🚗 *Vagas:* ${i.vagas}\n`;
                        if (i.area) msg += `📏 *Área:* ${i.area} m²\n`;
                    }
                    
                    if (i.modalidade) {
                        msg += `📅 *Status:* ${Utils.getModalidadeText(i.modalidade)}\n`;
                    }
                    
                    if (i.localizacao) {
                        msg += `📍 *Localização:* ${i.localizacao}\n`;
                    }
                    
                    if (i.construtora) {
                        msg += `🏢 *Construtora:* ${i.construtora}\n`;
                    }
                    
                    msg += `\n*Contato:* ${settings.nome}\n`;
                    msg += `📞 ${settings.telefone}\n\n`;
                    msg += `_Interessado(a) neste imóvel? Entre em contato para mais informações!_`;
                    
                    const encodedMsg = encodeURIComponent(msg);
                    window.open(`https://wa.me/?text=${encodedMsg}`, '_blank');
                }
            },
            
            relatorios: {
                gerarVendas: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('RELATÓRIO DE VENDAS', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    
                    // Clientes fechados
                    const clientesFechados = UI.data.clientes.filter(c => c.status === 'closed');
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth() + 1;
                    const anoAtual = hoje.getFullYear();
                    
                    // Vendas do mês
                    const vendasMes = clientesFechados.filter(c => 
                        c.dataFechamento && 
                        c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    );
                    
                    let y = 60;
                    
                    if (vendasMes.length === 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Nenhuma venda registrada neste mês.', 20, y);
                    } else {
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text(`VENDAS DO MÊS (${vendasMes.length}):`, 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        vendasMes.forEach((c, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.text(`${index + 1}. ${c.nome}`, 25, y);
                            y += 7;
                            doc.text(`   CPF: ${c.cpf || 'Não informado'}`, 25, y);
                            y += 7;
                            doc.text(`   Valor: ${c.valorVenda ? Utils.formatCurrency(c.valorVenda) : 'Não informado'}`, 25, y);
                            y += 7;
                            doc.text(`   Data: ${c.dataFechamento ? Utils.formatDate(c.dataFechamento) : 'Não informada'}`, 25, y);
                            y += 10;
                        });
                        
                        // Totais
                        y += 5;
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        const totalVendas = vendasMes.length;
                        const totalReceita = vendasMes.reduce((acc, c) => acc + (c.valorVenda || 0), 0);
                        
                        doc.text(`TOTAL DE VENDAS: ${totalVendas}`, 20, y);
                        y += 8;
                        doc.text(`RECEITA TOTAL: ${Utils.formatCurrency(totalReceita)}`, 20, y);
                        y += 8;
                        
                        if (totalVendas > 0) {
                            const ticketMedio = totalReceita / totalVendas;
                            doc.text(`TICKET MÉDIO: ${Utils.formatCurrency(ticketMedio)}`, 20, y);
                        }
                    }
                    
                    // Vendas totais (todos os tempos)
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('HISTÓRICO DE VENDAS', 105, y, { align: 'center' });
                    y += 15;
                    
                    if (clientesFechados.length === 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Nenhuma venda registrada no histórico.', 20, y);
                    } else {
                        // Agrupar por ano/mês
                        const vendasPorMes = {};
                        clientesFechados.forEach(c => {
                            if (c.dataFechamento) {
                                const mesAno = c.dataFechamento.substring(0, 7);
                                if (!vendasPorMes[mesAno]) {
                                    vendasPorMes[mesAno] = { vendas: 0, receita: 0 };
                                }
                                vendasPorMes[mesAno].vendas++;
                                vendasPorMes[mesAno].receita += c.valorVenda || 0;
                            }
                        });
                        
                        // Ordenar por data
                        const meses = Object.keys(vendasPorMes).sort();
                        
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        
                        meses.forEach((mes, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            const [ano, mesNum] = mes.split('-');
                            const dados = vendasPorMes[mes];
                            
                            doc.text(`${index + 1}. ${mesNum}/${ano}: ${dados.vendas} venda(s) - ${Utils.formatCurrency(dados.receita)}`, 20, y);
                            y += 10;
                        });
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Vendas_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Relatório de vendas gerado em PDF!');
                },
                
                gerarPlantao: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('RELATÓRIO DE PLANTÃO', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    
                    // Agendamentos do tipo plantão
                    const plantoes = UI.data.agenda.filter(a => a.tipo === 'plantao');
                    let y = 60;
                    
                    if (plantoes.length === 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Nenhum plantão registrado.', 20, y);
                    } else {
                        // Agrupar por data
                        const plantoesPorData = {};
                        plantoes.forEach(p => {
                            if (!plantoesPorData[p.data]) {
                                plantoesPorData[p.data] = [];
                            }
                            plantoesPorData[p.data].push(p);
                        });
                        
                        // Ordenar datas
                        const datas = Object.keys(plantoesPorData).sort();
                        
                        datas.forEach(data => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.setFontSize(14);
                            doc.setTextColor(59, 130, 246);
                            doc.text(`DATA: ${Utils.formatDate(data)}`, 20, y);
                            y += 10;
                            
                            const plantoesDia = plantoesPorData[data];
                            plantoesDia.forEach((p, index) => {
                                if (y > 270) {
                                    doc.addPage();
                                    y = 20;
                                }
                                
                                const c = UI.data.clientes.find(cl => cl.id === p.clienteId);
                                doc.setFontSize(10);
                                doc.setTextColor(0, 0, 0);
                                
                                doc.text(`${index + 1}. Horário: ${p.horario}`, 25, y);
                                y += 7;
                                
                                if (c) {
                                    doc.text(`   Cliente: ${c.nome}`, 25, y);
                                    y += 7;
                                }
                                
                                if (p.local) {
                                    doc.text(`   Local: ${p.local}`, 25, y);
                                    y += 7;
                                }
                                
                                if (p.descricao) {
                                    const descLines = doc.splitTextToSize(`   Obs: ${p.descricao}`, 150);
                                    descLines.forEach(line => {
                                        doc.text(line, 25, y);
                                        y += 7;
                                    });
                                }
                                y += 5;
                            });
                            y += 10;
                        });
                        
                        // Totais
                        y += 5;
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(`TOTAL DE PLANTÕES: ${plantoes.length}`, 20, y);
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Plantao_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Relatório de plantão gerado em PDF!');
                },
                
                gerarClientes: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('RELATÓRIO DE CLIENTES', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    doc.text(`Total de Clientes: ${UI.data.clientes.length}`, 20, 48);
                    
                    // Estatísticas por status
                    const statusCount = {};
                    UI.data.clientes.forEach(c => {
                        statusCount[c.status] = (statusCount[c.status] || 0) + 1;
                    });
                    
                    let y = 70;
                    
                    // Tabela de status
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('DISTRIBUIÇÃO POR STATUS:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    Object.entries(statusCount).forEach(([status, count]) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.text(`${Utils.getStatusText(status)}: ${count} clientes`, 25, y);
                        y += 8;
                    });
                    
                    // Lista de clientes
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('LISTA COMPLETA DE CLIENTES', 105, y, { align: 'center' });
                    y += 15;
                    
                    if (UI.data.clientes.length === 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Nenhum cliente cadastrado.', 20, y);
                    } else {
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        UI.data.clientes.forEach((c, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.text(`${index + 1}. ${c.nome}`, 20, y);
                            y += 7;
                            doc.text(`   Telefone: ${c.telefone}`, 20, y);
                            y += 7;
                            doc.text(`   Status: ${Utils.getStatusText(c.status)}`, 20, y);
                            y += 7;
                            doc.text(`   Cadastro: ${Utils.formatDate(c.dataCadastro)}`, 20, y);
                            y += 10;
                        });
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Clientes_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Relatório de clientes gerado em PDF!');
                },
                
                gerarImoveis: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('RELATÓRIO DE IMÓVEIS', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    doc.text(`Total de Imóveis: ${UI.data.imoveis.length}`, 20, 48);
                    
                    // Estatísticas por status
                    const statusCount = {};
                    const modalidadeCount = {};
                    
                    UI.data.imoveis.forEach(i => {
                        statusCount[i.status] = (statusCount[i.status] || 0) + 1;
                        modalidadeCount[i.modalidade] = (modalidadeCount[i.modalidade] || 0) + 1;
                    });
                    
                    let y = 70;
                    
                    // Tabela de status
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('DISTRIBUIÇÃO POR STATUS:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    Object.entries(statusCount).forEach(([status, count]) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        const statusText = status === 'disponivel' ? 'Disponível' : 
                                         status === 'reservado' ? 'Reservado' : 'Vendido';
                        doc.text(`${statusText}: ${count} imóveis`, 25, y);
                        y += 8;
                    });
                    
                    y += 5;
                    
                    // Tabela de modalidade
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('DISTRIBUIÇÃO POR MODALIDADE:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    Object.entries(modalidadeCount).forEach(([modalidade, count]) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.text(`${Utils.getModalidadeText(modalidade)}: ${count} imóveis`, 25, y);
                        y += 8;
                    });
                    
                    // Lista de imóveis
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('LISTA COMPLETA DE IMÓVEIS', 105, y, { align: 'center' });
                    y += 15;
                    
                    if (UI.data.imoveis.length === 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Nenhum imóvel cadastrado.', 20, y);
                    } else {
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        UI.data.imoveis.forEach((i, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.text(`${index + 1}. ${i.nome}`, 20, y);
                            y += 7;
                            doc.text(`   Valor: ${Utils.formatCurrency(i.valor)}`, 20, y);
                            y += 7;
                            doc.text(`   Modalidade: ${Utils.getModalidadeText(i.modalidade)}`, 20, y);
                            y += 7;
                            doc.text(`   Status: ${i.status === 'disponivel' ? 'Disponível' : i.status === 'reservado' ? 'Reservado' : 'Vendido'}`, 20, y);
                            y += 10;
                        });
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Imoveis_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Relatório de imóveis gerado em PDF!');
                },
                
                gerarAniversariantes: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth() + 1;
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('RELATÓRIO DE ANIVERSARIANTES', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    doc.text(`Mês de referência: ${mesAtual}`, 20, 48);
                    
                    // Filtrar clientes que fazem aniversário no mês
                    const clientesMes = UI.data.clientes.filter(c => {
                        if (!c.nascimento) return false;
                        const [, mes] = c.nascimento.split('-');
                        return parseInt(mes) === mesAtual;
                    });
                    
                    // Ordenar por dia
                    clientesMes.sort((a, b) => {
                        const [, , diaA] = a.nascimento.split('-');
                        const [, , diaB] = b.nascimento.split('-');
                                        return parseInt(diaA) - parseInt(diaB);
                    });
                    
                    let y = 70;
                    
                    if (clientesMes.length === 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Nenhum cliente faz aniversário neste mês.', 20, y);
                    } else {
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text(`ANIVERSARIANTES DO MÊS (${clientesMes.length}):`, 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        clientesMes.forEach((c, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            const idade = Utils.calcularIdade(c.nascimento);
                            const proximaIdade = idade !== null ? idade + 1 : null;
                            const [, , dia] = c.nascimento.split('-');
                            
                            doc.text(`${index + 1}. ${c.nome}`, 25, y);
                            y += 7;
                            doc.text(`   Data: ${dia}/${mesAtual} ${proximaIdade ? `(${proximaIdade} anos)` : ''}`, 25, y);
                            y += 7;
                            doc.text(`   Telefone: ${c.telefone}`, 25, y);
                            y += 7;
                            doc.text(`   Status: ${Utils.getStatusText(c.status)}`, 25, y);
                            y += 10;
                        });
                    }
                    
                    // Próximos aniversários (próximos 30 dias)
                    const hojeISO = Utils.getToday();
                    const dataFutura = new Date();
                    dataFutura.setDate(dataFutura.getDate() + 30);
                    const dataFuturaISO = dataFutura.toISOString().split('T')[0];
                    
                    const proximosAniversarios = UI.data.clientes.filter(c => {
                        if (!c.nascimento) return false;
                        
                        const [ano, mes, dia] = c.nascimento.split('-');
                        const dataAniversario = new Date(hoje.getFullYear(), parseInt(mes) - 1, parseInt(dia));
                        
                        return dataAniversario >= hoje && dataAniversario <= dataFutura;
                    });
                    
                    if (proximosAniversarios.length > 0) {
                        doc.addPage();
                        y = 20;
                        
                        doc.setFontSize(20);
                        doc.setTextColor(59, 130, 246);
                        doc.text('PRÓXIMOS ANIVERSÁRIOS (30 DIAS)', 105, y, { align: 'center' });
                        y += 15;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        proximosAniversarios.forEach((c, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            const idade = Utils.calcularIdade(c.nascimento);
                            const proximaIdade = idade !== null ? idade + 1 : null;
                            const [ano, mes, dia] = c.nascimento.split('-');
                            const dataAniversario = new Date(hoje.getFullYear(), parseInt(mes) - 1, parseInt(dia));
                            const diasRestantes = Math.ceil((dataAniversario - hoje) / (1000 * 60 * 60 * 24));
                            
                            doc.text(`${index + 1}. ${c.nome}`, 20, y);
                            y += 7;
                            doc.text(`   Data: ${Utils.formatDate(c.nascimento)} (em ${diasRestantes} dia${diasRestantes !== 1 ? 's' : ''})`, 20, y);
                            y += 7;
                            doc.text(`   Idade: ${proximaIdade || 'N/A'} anos`, 20, y);
                            y += 7;
                            doc.text(`   Telefone: ${c.telefone}`, 20, y);
                            y += 10;
                        });
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Aniversariantes_${mesAtual}_${hoje.getFullYear()}.pdf`);
                    Utils.toast('Relatório de aniversariantes gerado em PDF!');
                },
                
                gerarDesempenhoFunil: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('DESEMPENHO DO FUNIL', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    
                    // Estatísticas do funil
                    const clientes = UI.data.clientes;
                    const totalClientes = clientes.length;
                    const totalFechados = clientes.filter(c => c.status === 'closed').length;
                    const totalPerdidos = clientes.filter(c => c.status === 'lost').length;
                    
                    const taxaConversao = totalClientes > 0 ? Math.round((totalFechados / totalClientes) * 100) : 0;
                    
                    // Tempo médio no funil
                    let tempoMedio = 0;
                    const fechados = clientes.filter(c => c.status === 'closed');
                    if (fechados.length > 0) {
                        const tempos = fechados.map(c => Utils.calcularTempoFunil(c));
                        tempoMedio = Math.round(tempos.reduce((a, b) => a + b, 0) / tempos.length);
                    }
                    
                    // Valor médio das vendas
                    const valorMedio = fechados.length > 0 ? 
                        fechados.reduce((acc, c) => acc + (c.valorVenda || 0), 0) / fechados.length : 0;
                    
                    let y = 70;
                    
                    // Estatísticas gerais
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('ESTATÍSTICAS GERAIS:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    doc.text(`Total de Clientes no Funil: ${totalClientes}`, 25, y);
                    y += 8;
                    doc.text(`Vendas Realizadas (Fechados): ${totalFechados}`, 25, y);
                    y += 8;
                    doc.text(`Perdidos: ${totalPerdidos}`, 25, y);
                    y += 8;
                    doc.text(`Taxa de Conversão: ${taxaConversao}%`, 25, y);
                    y += 8;
                    doc.text(`Tempo Médio no Funil: ${tempoMedio} dias`, 25, y);
                    y += 8;
                    doc.text(`Ticket Médio: ${Utils.formatCurrency(valorMedio)}`, 25, y);
                    y += 15;
                    
                    // Distribuição por etapa
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('DISTRIBUIÇÃO POR ETAPA:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    const etapas = UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem);
                    etapas.forEach(etapa => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        const clientesEtapa = clientes.filter(c => c.status === etapa.id).length;
                        const porcentagem = totalClientes > 0 ? Math.round((clientesEtapa / totalClientes) * 100) : 0;
                        
                        doc.text(`${etapa.nome}: ${clientesEtapa} clientes (${porcentagem}%)`, 25, y);
                        y += 8;
                    });
                    
                    // Análise de conversão entre etapas
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('ANÁLISE DE CONVERSÃO ENTRE ETAPAS', 105, y, { align: 'center' });
                    y += 15;
                    
                    if (etapas.length >= 2) {
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        for (let i = 0; i < etapas.length - 1; i++) {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            const etapaAtual = etapas[i];
                            const proximaEtapa = etapas[i + 1];
                            
                            const clientesAtual = clientes.filter(c => c.status === etapaAtual.id).length;
                            const clientesProxima = clientes.filter(c => c.status === proximaEtapa.id).length;
                            
                            const taxaConversaoEtapa = clientesAtual > 0 ? Math.round((clientesProxima / clientesAtual) * 100) : 0;
                            
                            doc.text(`${etapaAtual.nome} → ${proximaEtapa.nome}:`, 20, y);
                            y += 7;
                            doc.text(`   ${clientesAtual} → ${clientesProxima} (${taxaConversaoEtapa}% de conversão)`, 25, y);
                            y += 10;
                        }
                    }
                    
                    // Top 5 clientes no funil há mais tempo
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('CLIENTES COM MAIS TEMPO NO FUNIL', 105, y, { align: 'center' });
                    y += 15;
                    
                    const clientesOrdenados = [...clientes]
                        .filter(c => c.status !== 'closed' && c.status !== 'lost')
                        .sort((a, b) => Utils.calcularTempoFunil(b) - Utils.calcularTempoFunil(a))
                        .slice(0, 10);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    clientesOrdenados.forEach((c, index) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        const tempo = Utils.calcularTempoFunil(c);
                        const etapa = etapas.find(e => e.id === c.status) || { nome: 'Sem etapa' };
                        
                        doc.text(`${index + 1}. ${c.nome}`, 20, y);
                        y += 7;
                        doc.text(`   Etapa: ${etapa.nome}`, 20, y);
                        y += 7;
                        doc.text(`   Tempo no funil: ${tempo} dias`, 20, y);
                        y += 7;
                        doc.text(`   Último contato: ${c.ultimoContato ? Utils.formatDate(c.ultimoContato) : 'Nunca'}`, 20, y);
                        y += 10;
                    });
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Desempenho_Funil_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Relatório de desempenho do funil gerado em PDF!');
                },
                
                gerarMetas: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    const metas = UI.data.metas;
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('RELATÓRIO DE METAS', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    doc.text(`Data da Configuração: ${metas.dataConfig ? Utils.formatDate(metas.dataConfig) : 'Não configurada'}`, 20, 48);
                    
                    let y = 70;
                    
                    // Configuração atual de metas
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('CONFIGURAÇÃO ATUAL DE METAS:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    doc.text(`Meta de Leads/Mês: ${metas.metaLeads || 0}`, 25, y);
                    y += 8;
                    doc.text(`Conversão Leads → Visitas: ${metas.convLeadsVisitas || 0}%`, 25, y);
                    y += 8;
                    doc.text(`Conversão Visitas → Docs: ${metas.convVisitasDocs || 0}%`, 25, y);
                    y += 8;
                    doc.text(`Conversão Docs → Aprovações: ${metas.convDocsAprovacoes || 0}%`, 25, y);
                    y += 8;
                    doc.text(`Conversão Aprovações → Vendas: ${metas.convAprovacoesVendas || 0}%`, 25, y);
                    y += 15;
                    
                    // Cálculo das metas derivadas
                    const metaLeads = metas.metaLeads || 0;
                    const metaVisitas = metaLeads * (metas.convLeadsVisitas / 100);
                    const metaDocs = metaVisitas * (metas.convVisitasDocs / 100);
                    const metaAprovacoes = metaDocs * (metas.convDocsAprovacoes / 100);
                    const metaVendas = metaAprovacoes * (metas.convAprovacoesVendas / 100);
                    
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('METAS DERIVADAS:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    doc.text(`Meta de Visitas/Mês: ${Math.round(metaVisitas)}`, 25, y);
                    y += 8;
                    doc.text(`Meta de Documentos/Mês: ${Math.round(metaDocs)}`, 25, y);
                    y += 8;
                    doc.text(`Meta de Aprovações/Mês: ${Math.round(metaAprovacoes)}`, 25, y);
                    y += 8;
                    doc.text(`Meta de Vendas/Mês: ${Math.round(metaVendas)}`, 25, y);
                    y += 15;
                    
                    // Progresso atual
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth() + 1;
                    const anoAtual = hoje.getFullYear();
                    
                    const leadsMes = UI.data.clientes.filter(c => 
                        c.dataCadastro && 
                        c.dataCadastro.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    const visitasMes = UI.data.agenda.filter(a => 
                        a.tipo === 'visita' && 
                        a.data &&
                        a.data.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    const docsMes = UI.data.clientes.filter(c => 
                        c.status === 'contract' && 
                        c.dataContrato &&
                        c.dataContrato.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    const aprovacoesMes = UI.data.clientes.filter(c => 
                        c.status === 'closed' && 
                        c.dataFechamento &&
                        c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length;
                    
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('PROGRESSO DO MÊS ATUAL:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    doc.text(`Leads: ${leadsMes}/${metaLeads} (${Math.round((leadsMes/metaLeads)*100)}%)`, 25, y);
                    y += 8;
                    doc.text(`Visitas: ${visitasMes}/${Math.round(metaVisitas)} (${Math.round((visitasMes/metaVisitas)*100)}%)`, 25, y);
                    y += 8;
                    doc.text(`Documentos: ${docsMes}/${Math.round(metaDocs)} (${Math.round((docsMes/metaDocs)*100)}%)`, 25, y);
                    y += 8;
                    doc.text(`Aprovações: ${aprovacoesMes}/${Math.round(metaAprovacoes)} (${Math.round((aprovacoesMes/metaAprovacoes)*100)}%)`, 25, y);
                    y += 8;
                    doc.text(`Vendas: ${aprovacoesMes}/${Math.round(metaVendas)} (${Math.round((aprovacoesMes/metaVendas)*100)}%)`, 25, y);
                    y += 15;
                    
                    // Análise de performance
                    const diasPassados = hoje.getDate();
                    const totalDiasMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
                    const percentualMes = Math.round((diasPassados / totalDiasMes) * 100);
                    
                    const progressoLeads = metaLeads > 0 ? Math.round((leadsMes / metaLeads) * 100) : 0;
                    const progressoVendas = metaVendas > 0 ? Math.round((aprovacoesMes / metaVendas) * 100) : 0;
                    
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('ANÁLISE DE PERFORMANCE:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    doc.text(`Dias passados: ${diasPassados}/${totalDiasMes} (${percentualMes}% do mês)`, 25, y);
                    y += 8;
                    doc.text(`Progresso de Leads: ${progressoLeads}%`, 25, y);
                    y += 8;
                    doc.text(`Progresso de Vendas: ${progressoVendas}%`, 25, y);
                    y += 8;
                    doc.text(`Tendência de Vendas: ${App.metas.calcularTendencia()} vendas projetadas`, 25, y);
                    y += 8;
                    
                    if (progressoVendas >= percentualMes) {
                        doc.setTextColor(0, 150, 0);
                        doc.text(`✅ No ritmo certo para bater a meta!`, 25, y);
                    } else {
                        doc.setTextColor(200, 0, 0);
                        doc.text(`⚠️ Abaixo do ritmo necessário para bater a meta`, 25, y);
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Metas_${mesAtual}_${anoAtual}.pdf`);
                    Utils.toast('Relatório de metas gerado em PDF!');
                },
                
                gerarFinanceiro: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(59, 130, 246);
                    doc.text('RELATÓRIO FINANCEIRO', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`CRECI: ${settings.creci}`, 20, 36);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
                    
                    // Clientes fechados com valor de venda
                    const clientesFechados = UI.data.clientes.filter(c => c.status === 'closed' && c.valorVenda);
                    
                    let y = 70;
                    
                    if (clientesFechados.length === 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Nenhuma venda com valor registrada.', 20, y);
                    } else {
                        // Totais
                        const totalVendas = clientesFechados.length;
                        const totalReceita = clientesFechados.reduce((acc, c) => acc + c.valorVenda, 0);
                        const ticketMedio = totalReceita / totalVendas;
                        
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('RESUMO FINANCEIRO:', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        doc.text(`Total de Vendas: ${totalVendas}`, 25, y);
                        y += 8;
                        doc.text(`Receita Total: ${Utils.formatCurrency(totalReceita)}`, 25, y);
                        y += 8;
                        doc.text(`Ticket Médio: ${Utils.formatCurrency(ticketMedio)}`, 25, y);
                        y += 15;
                        
                        // Vendas por mês
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('VENDAS POR MÊS:', 20, y);
                        y += 10;
                        
                        // Agrupar por mês
                        const vendasPorMes = {};
                        clientesFechados.forEach(c => {
                            if (c.dataFechamento) {
                                const mesAno = c.dataFechamento.substring(0, 7);
                                if (!vendasPorMes[mesAno]) {
                                    vendasPorMes[mesAno] = { vendas: 0, receita: 0 };
                                }
                                vendasPorMes[mesAno].vendas++;
                                vendasPorMes[mesAno].receita += c.valorVenda;
                            }
                        });
                        
                        // Ordenar por data
                        const meses = Object.keys(vendasPorMes).sort();
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        meses.forEach((mes, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            const [ano, mesNum] = mes.split('-');
                            const dados = vendasPorMes[mes];
                            const ticketMes = dados.vendas > 0 ? dados.receita / dados.vendas : 0;
                            
                            doc.text(`${index + 1}. ${mesNum}/${ano}:`, 25, y);
                            y += 7;
                            doc.text(`   Vendas: ${dados.vendas}`, 30, y);
                            y += 7;
                            doc.text(`   Receita: ${Utils.formatCurrency(dados.receita)}`, 30, y);
                            y += 7;
                            doc.text(`   Ticket Médio: ${Utils.formatCurrency(ticketMes)}`, 30, y);
                            y += 10;
                        });
                        
                        // Top 5 maiores vendas
                        doc.addPage();
                        y = 20;
                        
                        doc.setFontSize(20);
                        doc.setTextColor(59, 130, 246);
                        doc.text('MAIORES VENDAS', 105, y, { align: 'center' });
                        y += 15;
                        
                        const maioresVendas = [...clientesFechados]
                            .sort((a, b) => (b.valorVenda || 0) - (a.valorVenda || 0))
                            .slice(0, 10);
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        maioresVendas.forEach((c, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.text(`${index + 1}. ${c.nome}`, 20, y);
                            y += 7;
                            doc.text(`   Valor: ${Utils.formatCurrency(c.valorVenda)}`, 20, y);
                            y += 7;
                            doc.text(`   Data: ${c.dataFechamento ? Utils.formatDate(c.dataFechamento) : 'Não informada'}`, 20, y);
                            y += 10;
                        });
                    }
                    
                    // Imóveis vendidos com valor
                    const imoveisVendidos = UI.data.imoveis.filter(i => i.status === 'vendido' && i.valor);
                    
                    if (imoveisVendidos.length > 0) {
                        doc.addPage();
                        y = 20;
                        
                        doc.setFontSize(20);
                        doc.setTextColor(59, 130, 246);
                        doc.text('IMÓVEIS VENDIDOS', 105, y, { align: 'center' });
                        y += 15;
                        
                        const totalImoveisVendidos = imoveisVendidos.length;
                        const totalValorImoveis = imoveisVendidos.reduce((acc, i) => acc + i.valor, 0);
                        const valorMedioImoveis = totalValorImoveis / totalImoveisVendidos;
                        
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('RESUMO:', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        doc.text(`Total de Imóveis Vendidos: ${totalImoveisVendidos}`, 25, y);
                        y += 8;
                        doc.text(`Valor Total: ${Utils.formatCurrency(totalValorImoveis)}`, 25, y);
                        y += 8;
                        doc.text(`Valor Médio: ${Utils.formatCurrency(valorMedioImoveis)}`, 25, y);
                        y += 15;
                        
                        // Lista de imóveis vendidos
                        doc.setFontSize(14);
                        doc.setTextColor(59, 130, 246);
                        doc.text('DETALHES:', 20, y);
                        y += 10;
                        
                        imoveisVendidos.forEach((i, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.text(`${index + 1}. ${i.nome}`, 25, y);
                            y += 7;
                            doc.text(`   Valor: ${Utils.formatCurrency(i.valor)}`, 25, y);
                            y += 7;
                            doc.text(`   Modalidade: ${Utils.getModalidadeText(i.modalidade)}`, 25, y);
                            y += 7;
                            doc.text(`   Data de Venda: ${i.dataVenda ? Utils.formatDate(i.dataVenda) : 'Não informada'}`, 25, y);
                            y += 10;
                        });
                    }
                    
                    // Rodapé
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Documento gerado pelo ImobiManager Pro', 105, 285, { align: 'center' });
                    
                    doc.save(`Relatorio_Financeiro_${new Date().toISOString().slice(0, 10)}.pdf`);
                    Utils.toast('Relatório financeiro gerado em PDF!');
                }
            },
            
            backup: {
                exportData: () => {
                    const data = {
                        clientes: UI.data.clientes,
                        imoveis: UI.data.imoveis,
                        agenda: UI.data.agenda,
                        metas: UI.data.metas,
                        funilEtapas: UI.data.funilEtapas,
                        settings: Storage.getSettings(),
                        dataExportacao: new Date().toISOString(),
                        versao: '2.0'
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_imobimanager_pro_${new Date().toISOString().slice(0, 10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    Utils.toast('Backup exportado com sucesso!');
                },
                
                importTrigger: () => {
                    document.getElementById('import-file').click();
                },
                
                importData: (input) => {
                    const file = input.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // Verificar versão
                            if (!data.versao) {
                                Utils.toast('Arquivo de backup inválido ou versão antiga', 'error');
                                return;
                            }
                            
                            if (confirm('Importar backup? Isso substituirá todos os dados atuais.')) {
                                if (data.clientes) Storage.set('clientes', data.clientes);
                                if (data.imoveis) Storage.set('imoveis', data.imoveis);
                                if (data.agenda) Storage.set('agenda', data.agenda);
                                if (data.metas) Storage.saveMetas(data.metas);
                                if (data.funilEtapas) Storage.saveFunilEtapas(data.funilEtapas);
                                if (data.settings) Storage.saveSettings(data.settings);
                                
                                location.reload();
                                Utils.toast('Backup importado com sucesso!');
                            }
                        } catch (err) {
                            Utils.toast('Erro ao ler arquivo de backup', 'error');
                            console.error(err);
                        }
                    };
                    reader.readAsText(file);
                },
                
                clearData: () => {
                    if (confirm('⚠️ ATENÇÃO!\n\nTem certeza que deseja resetar todos os dados?\n\nEsta ação apagará TODOS os clientes, imóveis, agendamentos, metas e configurações.\n\nEsta ação NÃO PODE ser desfeita!')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            }
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
            
            // Configurar tema inicial
            const settings = Storage.getSettings();
            const themeToggle = document.querySelector('.theme-toggle i');
            if (settings.tema === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.className = 'fas fa-sun';
            } else {
                themeToggle.className = 'fas fa-moon';
            }
        });

        // --- EXPORTAR FUNÇÕES PARA O ESCOPO GLOBAL ---
        window.UI = UI;
        window.App = App;
        window.Utils = Utils;
    </script>
</body>
</html>